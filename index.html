<!doctype html>
<html lang="ru"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1">
<title>Elementix ‚Äî –∞–ª—Ö–∏–º–∏—è</title><meta name="color-scheme" content="dark"><meta name="theme-color" content="#0b0f14">
<style>
:root{--bg:#0b0f14;--panel:#10161d;--panel2:#0b1218;--line:#1f2a39;--ink:#e7ecf4;--muted:#9fb0bf;--accent:#6fb1ff;--gold:#ffd166;--success:#8aff9c}
*{box-sizing:border-box}html,body{height:100%;margin:0;color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans",sans-serif}
body{background:radial-gradient(800px 480px at 80% -10%, #182335, #0b0f14)}
.app{min-height:100%;display:flex;flex-direction:column}

/* header */
.header{position:sticky;top:0;z-index:80;display:flex;align-items:center;gap:10px;height:48px;padding:0 12px;border-bottom:1px solid var(--line);background:rgba(11,15,20,.9);backdrop-filter:blur(8px)}
.title{font-weight:800}.spacer{flex:1}
.gold{display:flex;align-items:center;gap:8px;background:#121b28;border:1px solid #253247;color:var(--gold);border-radius:999px;padding:6px 12px;font-weight:800}
.soundBtn{background:#162030;border:1px solid #223247;border-radius:10px;color:#cfe1ff;padding:6px 10px;cursor:pointer;display:flex;align-items:center;gap:6px}

/* crumbs under header */
.crumbs{position:sticky;top:48px;z-index:75;display:flex;gap:10px;align-items:center;overflow-x:auto;padding:8px 6px;background:rgba(11,15,20,.85);backdrop-filter:blur(6px);border-bottom:1px solid var(--line)}
.token{display:grid;place-items:center;width:42px;height:42px;border-radius:50%;background:linear-gradient(180deg,#0f1620,#0b1218);border:1px solid #203043;box-shadow:0 6px 18px rgba(0,0,0,.25)}.token .emo{font-size:22px}

/* main area */
.main{display:flex;flex-direction:column;gap:10px;padding:8px 12px calc(170px + env(safe-area-inset-bottom,0px))}

/* bowls */
.bowls{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.drop{position:relative;background:#0b1218;border:1px dashed #2a384b;border-radius:16px;min-height:140px;display:grid;place-items:center;overflow:hidden;box-shadow: inset 0 0 0 1px rgba(255,255,255,.02)}
.drop .hint{position:absolute;top:8px;left:12px;color:var(--muted);font-size:12px}
.selection{display:flex;gap:12px;align-items:center;animation:arrive .32s ease-out}
.selection .emoji{font-size:56px;filter:drop-shadow(0 8px 14px rgba(0,0,0,.35))}
.selection .name{font-size:14px;color:#d7e8ff}
@keyframes arrive{0%{transform:translateY(10px) scale(.9);opacity:0}100%{transform:translateY(0) scale(1);opacity:1}}

/* tools (search + actions) */
.tools{position:sticky;top:calc(48px + 56px);z-index:70;background:rgba(11,15,20,.85);backdrop-filter:blur(8px);border:1px solid #1b2a3a;border-radius:12px;padding:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.tools input{flex:1;background:#0b1218;border:1px solid var(--line);border-radius:10px;color:#cfe1ff;padding:10px}.count,.nextfree{font-size:12px;color:#9fb0bf}
.btn{background:#1b2633;border:1px solid #253247;color:#cfe1ff;border-radius:14px;padding:10px 12px;font-weight:700;cursor:pointer;transition:transform .05s ease, box-shadow .12s ease, background .12s ease}
.btn:hover{ box-shadow: 0 8px 18px rgba(0,0,0,.22) }
.btn:active{transform:translateY(1px)}
.btn.primary{background:#6fb1ff;border:none;color:#07101c;font-weight:900;padding:12px 18px;border-radius:18px;font-size:16px}

/* filter chips */
.chips{display:flex;gap:8px;overflow:auto;padding:6px 2px}
.chip{background:#111a23;border:1px solid #223247;color:#cfe1ff;border-radius:999px;padding:6px 10px;font-size:12px;white-space:nowrap;cursor:pointer}
.chip.active{background:#6fb1ff;color:#07101c;border-color:#6fb1ff;font-weight:900}
.mode{margin-left:auto;display:flex;gap:8px;align-items:center}
.toggle{background:#111a23;border:1px solid #223247;border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}
.toggle.active{background:#8aff9c;color:#062011;border-color:#3b8a59;font-weight:900}

/* carousels */
.carousel{display:flex;gap:8px;overflow:auto;padding:6px 0}
.pill{min-width:90px;background:linear-gradient(180deg,#101821,#0b1218);border:1px solid #1b2735;border-radius:14px;padding:8px;display:grid;gap:4px;place-items:center;cursor:grab}
.pill .emo{font-size:22px}.pill .nm{font-size:12px;color:#cfe1ff}

/* grid (virtualized container) */
.gridWrap{border:1px solid #1b2735;border-radius:12px;background:linear-gradient(180deg,#0d141c,#0a0f15)}
#grid{position:relative;height:560px;overflow:auto}
.gridInner{position:relative}
.card{position:absolute;width:calc(25% - 12px); /* mobile adjusts in JS */ background: linear-gradient(180deg, #101821, #0b1218); border: 1px solid #1b2735; border-radius: 14px; padding: 10px; display: grid; gap: 6px; cursor: grab; box-shadow: 0 6px 18px rgba(0,0,0,.22); transition: transform .08s ease, box-shadow .12s ease, border-color .12s ease}
.card:hover{ transform: translateY(-2px); box-shadow: 0 12px 26px rgba(0,0,0,.32); border-color: #263547; }
.card.locked{opacity:.45;filter:grayscale(.15);cursor:not-allowed;box-shadow:0 4px 12px rgba(0,0,0,.18)}
.emoji{ font-size: 30px; text-shadow: 0 6px 12px rgba(0,0,0,.35) }
.name{ font-size: 12px; color: #cfe1ff }
.tag{ position: absolute; top: 8px; right: 8px; font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 999px; background: #121b28; border: 1px solid #253247; color: #9fb0bf; }
.card[data-rarity="common"] .tag{ background: rgba(173,186,200,.12); border-color: rgba(173,186,200,.30); color: #b9c6d3 }
.card[data-rarity="rare"]   .tag{ background: rgba(111,177,255,.14); border-color: rgba(111,177,255,.32); color: #9dccff }
.card[data-rarity="epic"]   .tag{ background: rgba(255,209,102,.14); border-color: rgba(255,209,102,.36); color: #ffd166 }

/* dock */
.dock{position:fixed;left:0;right:0;bottom:0;z-index:85;background:linear-gradient(180deg, rgba(11,15,20,0), rgba(11,15,20,.95));padding:10px 12px calc(12px + env(safe-area-inset-bottom,0px));display:flex;justify-content:center}
.dock .inner{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center;max-width:900px;width:100%}
#hint{display:flex;flex-direction:column;align-items:center;gap:2px;min-width:180px;padding:12px 14px}.hline1{font-weight:900}.hline2{font-size:12px;opacity:.9}

/* toasts */
.toast{position:fixed;left:50%;bottom:96px;transform:translateX(-50%);background:#0b1218;border:1px solid #1f2a39;color:#cfe1ff;padding:10px 14px;border-radius:12px;opacity:0;animation:pop 5.2s ease-out forwards;z-index:9999}
@keyframes pop{0%{opacity:0;transform:translateX(-50%) translateY(8px)}8%{opacity:1;transform:translateX(-50%) translateY(0)}85%{opacity:1}100%{opacity:0;transform:translateX(-50%) translateY(4px)}}
.pulse{outline:2px solid #6fb1ff;box-shadow:0 0 0 0 rgba(111,177,255,.8),0 0 14px rgba(111,177,255,.6);animation:pulse 1.2s ease-out 2}

/* fly-to-bowl sprite */
.fly{position:fixed;left:0;top:0;pointer-events:none;z-index:200;will-change:transform;transition:transform .38s cubic-bezier(.18,.9,.24,1)}

/* BIG CELEBRATION MODAL */
.bigModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:3000}
.bigModal.show{display:flex;animation:fadeIn .2s ease}
.bigCard{width:min(92vw,560px);background:linear-gradient(180deg,#0f1722,#0b1218);border:1px solid #223347;border-radius:18px;padding:18px;box-shadow:0 24px 60px rgba(0,0,0,.5);text-align:center;position:relative;overflow:hidden}
.spark{position:absolute;inset:-2px;border-radius:20px;pointer-events:none;background:radial-gradient(400px 220px at 70% -10%, rgba(111,177,255,.25), transparent), radial-gradient(420px 180px at 10% 110%, rgba(138,255,179,.18), transparent)}
.badgeNew{display:inline-flex;align-items:center;gap:8px;background:rgba(138,255,156,.08);border:1px solid rgba(138,255,156,.35);color:var(--success);padding:6px 10px;border-radius:999px;font-weight:800;margin:6px auto 12px}
.elEmoji{font-size:70px;filter:drop-shadow(0 10px 18px rgba(0,0,0,.45))}
.elName{font-size:22px;font-weight:900;margin-top:6px}
.elRare{font-size:12px;margin-top:2px}
.elRare.common{color:#b9c6d3}.elRare.rare{color:#9dccff}.elRare.epic{color:#ffd166}
.fact{margin-top:12px;color:#cfe1ff;font-size:14px;line-height:1.35;opacity:.95}
.okBtn{margin-top:16px;background:#6fb1ff;border:none;color:#07101c;font-weight:900;padding:12px 18px;border-radius:12px;cursor:pointer}
#confetti{position:fixed;inset:0;pointer-events:none;z-index:2999}

/* Journal panel */
.journal{position:fixed;top:0;right:0;bottom:0;width:min(420px,92vw);background:#0b1218;border-left:1px solid #1f2a39;z-index:3500;transform:translateX(100%);transition:transform .28s cubic-bezier(.2,.8,.2,1), box-shadow .28s;box-shadow:-12px 0 28px rgba(0,0,0,0)}
.journal.show{transform:translateX(0);box-shadow:-12px 0 28px rgba(0,0,0,.35)}
.j-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #1f2a39;background:#0f1620}
.j-title{font-weight:900}
.j-close{background:#162030;border:1px solid #223247;border-radius:10px;color:#cfe1ff;padding:6px 10px;cursor:pointer}
.j-list{padding:10px 12px;overflow:auto}
.j-item{display:flex;align-items:center;gap:10px;padding:10px 8px;border-bottom:1px dashed #1b2a3a}
.j-emo{font-size:20px}.j-name{font-size:14px;color:#cfe1ff;font-weight:700}.j-time{margin-left:auto;font-size:12px;color:#9fb0bf}

/* FAB to top */
.fab{position:fixed;right:14px;bottom:110px;z-index:90;background:#0f1a26;border:1px solid #243447;border-radius:999px;color:#cfe1ff;padding:10px 12px;display:none}
.fab.show{display:block}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="title">Elementix ‚Äî –∞–ª—Ö–∏–º–∏—è</div>
    <div class="spacer"></div>
    <button class="soundBtn" id="soundBtn" title="–ó–≤—É–∫">üîä –ó–≤—É–∫</button>
    <div class="gold">ü™ô –ó–æ–ª–æ—Ç–æ: <span id="stars">20</span></div>
  </div>

  <div class="crumbs" id="crumbs"></div>

  <div class="main">
    <div class="bowls">
      <div class="drop" id="bA"><div class="hint">–ü–µ—Ä–µ—Ç–∞—â–∏ –∏–ª–∏ –∫–ª–∏–∫–Ω–∏ –∫–∞—Ä—Ç–æ—á–∫—É</div></div>
      <div class="drop" id="bB"><div class="hint">–ü–µ—Ä–µ—Ç–∞—â–∏ –∏–ª–∏ –∫–ª–∏–∫–Ω–∏ –∫–∞—Ä—Ç–æ—á–∫—É</div></div>
    </div>

    <div class="tools">
      <input id="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏‚Ä¶">
      <button id="logBtn" class="btn">üìú –ñ—É—Ä–Ω–∞–ª</button>
      <button id="reset" class="btn">–°–±—Ä–æ—Å</button>
      <div class="count">–û—Ç–∫—Ä—ã—Ç–æ: <span id="openCount">0</span> / <span id="totalCount">300</span> ‚Ä¢ v127p</div>
      <div class="nextfree" id="nextFreeText"></div>

      <div class="chips" id="chips">
        <div class="chip" data-chip="common">–û–±—ã—á–Ω—ã–π</div>
        <div class="chip" data-chip="rare">–†–µ–¥–∫–∏–π</div>
        <div class="chip" data-chip="epic">–≠–ø–∏—á–µ—Å–∫–∏–π</div>
        <div class="chip" data-chip="new">–ù–æ–≤–æ–µ</div>
        <div class="chip" data-chip="fav">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
      </div>
      <div class="mode">
        <div class="toggle" id="craftableToggle">–ú–æ–∂–Ω–æ —Å–∫—Ä–∞—Ñ—Ç–∏—Ç—å —Å–µ–π—á–∞—Å</div>
      </div>
    </div>

    <div>
      <div class="smallTitle" style="margin:2px 4px 4px 2px;color:#9fb0bf;font-size:12px">–ù–µ–¥–∞–≤–Ω–æ –æ—Ç–∫—Ä—ã—Ç—ã–µ</div>
      <div class="carousel" id="recentRow"></div>
      <div class="smallTitle" style="margin:6px 4px 4px 2px;color:#9fb0bf;font-size:12px">‚≠ê –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
      <div class="carousel" id="favRow"></div>
    </div>

    <div class="gridWrap">
      <div id="grid">
        <div id="gridInner" class="gridInner"></div>
      </div>
    </div>
  </div>

  <div class="dock"><div class="inner">
    <button id="hint" class="btn"><div class="hline1" id="h1">–ü–æ–¥—Å–∫–∞–∑–∫–∞</div><div class="hline2" id="h2">–±–µ—Å–ø–ª–∞—Ç–Ω–æ</div></button>
    <button id="mix" class="btn primary">–°–º–µ—à–∞—Ç—å</button>
    <button id="clear" class="btn">–û—á–∏—Å—Ç–∏—Ç—å —á–∞—à–∏</button>
  </div></div>
</div>

<button class="fab" id="toTop">‚¨ÜÔ∏è –ù–∞–≤–µ—Ä—Ö</button>

<!-- celebration modal + confetti -->
<canvas id="confetti" style="display:none"></canvas>
<div class="bigModal" id="newModal" aria-hidden="true">
  <div class="bigCard" role="dialog" aria-live="polite">
    <div class="spark"></div>
    <div class="badgeNew">‚ú® –ù–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç!</div>
    <div class="elEmoji" id="nmEmoji">‚ú®</div>
    <div class="elName" id="nmName">–ù–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç</div>
    <div class="elRare common" id="nmRare">–û–±—ã—á–Ω—ã–π</div>
    <div class="fact" id="nmFact">–ö–∞–∂–¥—ã–π –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç ‚Äî —à–∞–≥ –∫ –≤–µ–ª–∏–∫–∏–º –æ—Ç–∫—Ä—ã—Ç–∏—è–º!</div>
    <button class="okBtn" id="newOk">–û–∫–µ–π</button>
  </div>
</div>

<!-- Journal panel -->
<div id="journal" class="journal">
  <div class="j-head">
    <div class="j-title">–ñ—É—Ä–Ω–∞–ª –æ—Ç–∫—Ä—ã—Ç–∏–π</div>
    <button id="jClose" class="j-close">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
  <div id="jList" class="j-list"></div>
</div>

<script>
/* ===== Data (sample) ===== */
const BASE=[["fire","–û–≥–æ–Ω—å","üî•","common"],["water","–í–æ–¥–∞","üíß","common"],["earth","–ó–µ–º–ª—è","ü™®","common"],["air","–í–æ–∑–¥—É—Ö","üí®","common"]];
const OFFICIAL={"steam":{"n":"–ü–∞—Ä","e":"‚ô®Ô∏è","r":"common"},"mud":{"n":"–ì—Ä—è–∑—å","e":"üü´","r":"common"},"dust":{"n":"–ü—ã–ª—å","e":"üßπ","r":"common"},"lava":{"n":"–õ–∞–≤–∞","e":"üåã","r":"common"},"stone":{"n":"–ö–∞–º–µ–Ω—å","e":"üóø","r":"common"},"sand":{"n":"–ü–µ—Å–æ–∫","e":"üèñÔ∏è","r":"common"},"glass":{"n":"–°—Ç–µ–∫–ª–æ","e":"ü™ü","r":"common"},"pressure":{"n":"–î–∞–≤–ª–µ–Ω–∏–µ","e":"üßØ","r":"common"},"mountain":{"n":"–ì–æ—Ä–∞","e":"‚õ∞Ô∏è","r":"rare"},"rain":{"n":"–î–æ–∂–¥—å","e":"üåßÔ∏è","r":"common"},"energy":{"n":"–≠–Ω–µ—Ä–≥–∏—è","e":"‚ö°Ô∏è","r":"rare"},"cloud":{"n":"–¢—É—á–∞","e":"‚òÅÔ∏è","r":"common"},"ash":{"n":"–ü–µ–ø–µ–ª","e":"üå´Ô∏è","r":"common"},"clay":{"n":"–ì–ª–∏–Ω–∞","e":"üß±","r":"common"},"metal":{"n":"–ú–µ—Ç–∞–ª–ª","e":"üî©","r":"rare"},"wind":{"n":"–í–µ—Ç–µ—Ä","e":"üå¨Ô∏è","r":"common"},"ice":{"n":"–õ—ë–¥","e":"üßä","r":"common"},"snow":{"n":"–°–Ω–µ–≥","e":"‚ùÑÔ∏è","r":"common"},"storm":{"n":"–®—Ç–æ—Ä–º","e":"üå™Ô∏è","r":"rare"}};
const RECIPES={"air+air":"pressure","air+earth":"dust","air+fire":"energy","air+stone":"sand","air+water":"rain","earth+fire":"lava","earth+lava":"stone","earth+pressure":"mountain","earth+water":"clay","fire+air":"ash","fire+earth":"metal","fire+sand":"glass","lava+water":"stone","water+air":"cloud","fire+water":"steam","earth+water*":"mud"};

/* ===== Consts / State ===== */
const SAVE_KEY='elementix-v127p';
const SOUND_ON_KEY='elementix-sound-on';
const SOUND_URL = 'assets/new-element.mp3';
const FIXED_VOLUME = 0.8;
const MAX_ELEMENTS=300;
const HALF_DAY_MS=12*60*60*1000;
const HINT_COST=10;
const $=id=>document.getElementById(id);
const grid=$('grid'), gridInner=$('gridInner'), bA=$('bA'), bB=$('bB'), crumbs=$('crumbs');
const recentRow=$('recentRow'), favRow=$('favRow');
const chipsEl=$('chips'), craftableToggle=$('craftableToggle');
const toTop=$('toTop');

let state={
  disc:new Set(BASE.map(x=>x[0])),
  order:[...BASE.map(x=>x[0])],
  a:null,b:null,
  stars:20,lastFreeHintAt:0,
  journal:[],
  soundOn:true,
  fav:new Set(),
  recent:[], // array of ids, newest first
  filters:{rarity:null,isNew:false,fav:false,craftable:false},
  widthCols:4, cardW:0, cardH:132, gap:12, data:[]
};
try{
  const raw=localStorage.getItem(SAVE_KEY); if(raw){ const o=JSON.parse(raw);
    state.disc=new Set(o.d||BASE.map(x=>x[0])); state.order=o.o&&o.o.length?o.o:[...state.disc];
    state.a=o.a||null; state.b=o.b||null; state.stars=(typeof o.stars==='number')?o.stars:20; state.lastFreeHintAt=o.lastFreeHintAt||0;
    state.journal=Array.isArray(o.journal)?o.journal:[]; state.fav=new Set(o.fav||[]); state.recent=Array.isArray(o.recent)?o.recent:[];
  }
}catch{}
try{ const s=localStorage.getItem(SOUND_ON_KEY); if(s!==null) state.soundOn=(s==='1'); }catch{}
function persist(){ localStorage.setItem(SAVE_KEY, JSON.stringify({d:[...state.disc],o:state.order,a:state.a,b:state.b,stars:state.stars,lastFreeHintAt:state.lastFreeHintAt,journal:state.journal,fav:[...state.fav],recent:state.recent})); localStorage.setItem(SOUND_ON_KEY, state.soundOn?'1':'0'); }

/* ===== helpers ===== */
function ALL(){ const m=new Map(); BASE.forEach(([i,n,e,r])=>m.set(i,{id:i,n,e,r})); Object.entries(OFFICIAL).forEach(([k,v])=>m.set(k,{id:k,n:v.n,e:v.e,r:v.r})); return m; }
function REC(){ return Object.assign({}, RECIPES); }
function nameOf(id){ const it=ALL().get(id)||{n:id,e:'?'}; return `${it.e} ${it.n}`; }
function keyFor(a,b){ return [a,b].sort().join('+'); }
function canCraftNow(out){ // out appears from any pair of discovered
  const O=[...state.disc]; const R=REC();
  for(let i=0;i<O.length;i++){ for(let j=i;j<O.length;j++){ if(R[keyFor(O[i],O[j])]===out) return true; } }
  return false;
}

/* ===== Sound ===== */
let audioCtx=null;
function ensureAudio(){ if(!audioCtx){ audioCtx = new (window.AudioContext||window.webkitAudioContext)(); } return audioCtx; }
async function playSound(){ if(!state.soundOn) return; try{ const a = new Audio(SOUND_URL); a.volume = FIXED_VOLUME; await a.play(); }catch(e){ const ctx=ensureAudio(); const t0=ctx.currentTime; const bell=(f,s)=>{const o=ctx.createOscillator(),g=ctx.createGain(); o.type='sine'; o.frequency.value=f; g.gain.value=0; g.gain.setValueAtTime(0,t0+s); g.gain.linearRampToValueAtTime(0.6*FIXED_VOLUME,t0+s+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t0+s+0.45); o.connect(g); g.connect(ctx.destination); o.start(t0+s); o.stop(t0+s+0.5);}; bell(1046.5,0); bell(1318.5,.04); bell(1568,.08);} }
const soundBtn=$('soundBtn'); function updateSoundBtn(){ soundBtn.textContent= state.soundOn?'üîä –ó–≤—É–∫':'üîá –ó–≤—É–∫'; } soundBtn.addEventListener('click',()=>{ state.soundOn=!state.soundOn; updateSoundBtn(); persist(); }); updateSoundBtn();

/* ===== Confetti (decay) ===== */
let confettiTimer=null, confettiCanvas=$('confetti'), confettiStart=0;
function startConfetti(){
  if(confettiTimer) return;
  confettiCanvas.style.display='block';
  const ctx=confettiCanvas.getContext('2d');
  function fit(){ confettiCanvas.width=innerWidth; confettiCanvas.height=innerHeight; } fit(); addEventListener('resize',fit);
  const N=220; let parts=Array.from({length:N},()=>({x:Math.random()*innerWidth,y:Math.random()*-innerHeight,r:2+Math.random()*4,s:1+Math.random()*2.5,a:Math.random()*Math.PI*2,c:['#ffd166','#6fb1ff','#8aff9c','#ff9aa2','#fbd6ff'][Math.floor(Math.random()*5)]}));
  confettiStart=performance.now();
  function draw(now){
    const elapsed = now - confettiStart; let factor=1; if(elapsed>4000){ factor=Math.max(0,1-(elapsed-4000)/2000); }
    ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
    for(const p of parts){ if(elapsed>4000 && Math.random()>factor) continue; ctx.beginPath(); ctx.fillStyle=p.c; ctx.globalAlpha=0.85*factor; ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill(); p.y+=p.s; p.x+=Math.sin(p.a)*0.8; p.a+=0.02; if(p.y-p.r>confettiCanvas.height){ if(factor>0.05){ p.y=-10; p.x=Math.random()*confettiCanvas.width; } } }
    if(factor<=0){ stopConfetti(); return; }
    confettiTimer=requestAnimationFrame(draw);
  }
  confettiTimer=requestAnimationFrame(draw);
}
function stopConfetti(){ if(confettiTimer){ cancelAnimationFrame(confettiTimer); confettiTimer=null; } confettiCanvas.style.display='none'; }

/* ===== Modal celebration ===== */
const FACTS={"steam":"–ü–∞—Ä –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è, –ø–æ—Ç–æ–º—É —á—Ç–æ –≥–æ—Ä—è—á–∏–π –≤–æ–∑–¥—É—Ö –ª–µ–≥—á–µ —Ö–æ–ª–æ–¥–Ω–æ–≥–æ.","mud":"–ì—Ä—è–∑—å —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–ª–∞–≥—É –∏ –ø–æ–º–æ–≥–∞–µ—Ç —Ä–∞—Å—Ç–µ–Ω–∏—è–º —Ä–∞—Å—Ç–∏.","dust":"–ü—ã–ª—å ‚Äî –º–∏–∫—Ä–æ—á–∞—Å—Ç–∏—Ü—ã –∑–µ–º–ª–∏, –ø–µ—Å–∫–∞ –∏ –ø—ã–ª—å—Ü—ã.","lava":"–õ–∞–≤–∞ ‚Äî —Ä–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω–∞—è –ø–æ—Ä–æ–¥–∞ –∏–∑ –Ω–µ–¥—Ä –ó–µ–º–ª–∏.","stone":"–ö–∞–º–µ–Ω—å ‚Äî –æ—Å–Ω–æ–≤–∞ –≥–æ—Ä –∏ —Å–∫–∞–ª.","sand":"–°—Ç–µ–∫–ª–æ –¥–µ–ª–∞—é—Ç –∏–∑ –ø–µ—Å–∫–∞ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ.","glass":"–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Å—Ç–µ–∫–ª–∞ ‚Äî –∏–∑-–∑–∞ –∞–º–æ—Ä—Ñ–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã.","pressure":"–î–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω—è–µ—Ç —Å–≤–æ–π—Å—Ç–≤–∞ –≤–µ—â–µ—Å—Ç–≤.","mountain":"–ì–æ—Ä—ã —Ä–∞—Å—Ç—É—Ç, –∫–æ–≥–¥–∞ –ø–ª–∏—Ç—ã —Å—Ç–∞–ª–∫–∏–≤–∞—é—Ç—Å—è.","rain":"–î–æ–∂–¥—å ‚Äî –≤–æ–¥–∞ –∏–∑ –æ–±–ª–∞–∫–æ–≤.","energy":"–≠–Ω–µ—Ä–≥–∏—è –±—ã–≤–∞–µ—Ç —Ç–µ–ø–ª–æ–≤–∞—è, —ç–ª–µ–∫—Ç—Ä–∏—á–µ—Å–∫–∞—è –∏ –¥—Ä.","cloud":"–û–±–ª–∞–∫–∞ ‚Äî –∫–∞–ø–µ–ª—å–∫–∏ –≤–æ–¥—ã –≤ –≤–æ–∑–¥—É—Ö–µ.","ash":"–ü–µ–ø–µ–ª ‚Äî –æ—Å—Ç–∞—Ç–æ–∫ –≥–æ—Ä–µ–Ω–∏—è.","clay":"–ì–ª–∏–Ω–∞ –ª–∏–ø–∫–∞—è –∏–∑-–∑–∞ –º–µ–ª–∫–∏—Ö —á–∞—Å—Ç–∏—Ü.","metal":"–ú–µ—Ç–∞–ª–ª—ã –ø—Ä–æ–≤–æ–¥—è—Ç —Ç–æ–∫ –∏ —Ç–µ–ø–ª–æ.","wind":"–í–µ—Ç–µ—Ä ‚Äî –¥–≤–∏–∂—É—â–∏–π—Å—è –≤–æ–∑–¥—É—Ö.","ice":"–õ—ë–¥ ‚Äî –∑–∞–º—ë—Ä–∑—à–∞—è –≤–æ–¥–∞.","snow":"–°–Ω–µ–∂–∏–Ω–∫–∏ ‚Äî –∫—Ä–∏—Å—Ç–∞–ª–ª—ã –ª—å–¥–∞.","storm":"–®—Ç–æ—Ä–º ‚Äî —Å–∏–ª—å–Ω—ã–π –≤–µ—Ç–µ—Ä."};
let savedScrollY=0; function lockScroll(lock){ if(lock){ savedScrollY=scrollY; document.body.style.top=`-${savedScrollY}px`; document.body.style.position='fixed'; document.body.style.left='0'; document.body.style.right='0'; } else { document.body.style.position=''; document.body.style.top=''; document.body.style.left=''; document.body.style.right=''; scrollTo(0,savedScrollY||0);} }
function celebrateNew(id,item){
  $('nmEmoji').textContent=item.e||'‚ú®'; $('nmName').textContent=item.n||'–ù–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç'; const rare=item.r||'common'; const rr=rare==='epic'?'–≠–ø–∏—á–µ—Å–∫–∏–π':(rare==='rare'?'–†–µ–¥–∫–∏–π':'–û–±—ã—á–Ω—ã–π'); $('nmRare').textContent=rr; $('nmRare').className='elRare '+rare; $('nmFact').textContent=FACTS[id]||"–ö–∞–∂–¥—ã–π –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç ‚Äî —à–∞–≥ –∫ –≤–µ–ª–∏–∫–∏–º –æ—Ç–∫—Ä—ã—Ç–∏—è–º!";
  const modal=$('newModal'); lockScroll(true); modal.classList.add('show'); modal.setAttribute('aria-hidden','false'); startConfetti(); playSound();
  $('newOk').onclick=()=>{ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); stopConfetti(); lockScroll(false); };
}

/* ===== Journal ===== */
const jPanel=$('journal'), jList=$('jList'); function renderJournal(){ const fmt=iso=>{ try{const d=new Date(iso);return d.toLocaleString('ru-RU',{hour:'2-digit',minute:'2-digit',day:'2-digit',month:'2-digit'});}catch{return ''}}; jList.innerHTML=(state.journal||[]).map(it=>`<div class="j-item"><div class="j-emo">${it.e||'‚ú®'}</div><div class="j-name">${it.n||'–ù–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç'}</div><div class="j-time">${fmt(it.t)}</div></div>`).join('')||`<div style="color:#9fb0bf;opacity:.9;padding:12px">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –û—Ç–∫—Ä—ã–≤–∞–π –Ω–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã ‚Äî –∑–∞–ø–∏—Å–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å.</div>`; }
$('logBtn').addEventListener('click',()=>{ renderJournal(); jPanel.classList.add('show'); }); $('jClose').addEventListener('click',()=> jPanel.classList.remove('show'));

/* ===== Grid virtualization ===== */
function computeLayout(){
  const w = grid.clientWidth || innerWidth;
  // responsive columns
  let cols = 2; if(w>520) cols=3; if(w>760) cols=4; if(w>1024) cols=5;
  state.widthCols = cols;
  state.cardW = Math.floor((w - (cols-1)*state.gap) / cols);
  // set card width via style for absolute items
  const css = document.createElement('style'); css.id='dynW'; css.innerHTML=`.card{width:${state.cardW}px}`; const prev=document.getElementById('dynW'); if(prev) prev.remove(); document.head.appendChild(css);
}
function buildDataList(){
  const A=ALL(); const q=(($('search').value)||'').toLowerCase();
  let items=[...state.order].filter(id=>A.has(id)&&state.disc.has(id));
  // filters
  if(state.filters.rarity){ items = items.filter(id => (A.get(id).r||'common')===state.filters.rarity); }
  if(state.filters.isNew){ items = items.filter(id => state.recent.includes(id)); }
  if(state.filters.fav){ items = items.filter(id => state.fav.has(id)); }
  if(state.filters.craftable){ items = items.filter(id => canCraftNow(id)); }
  // search
  if(q){ items = items.filter(id => A.get(id).n.toLowerCase().includes(q)); }
  // to objects
  state.data = items.map(id=>({id, ...A.get(id)}));
}
function renderVirtual(){
  computeLayout();
  const gap=state.gap, cw=state.cardW, ch=state.cardH, cols=state.widthCols;
  const total=state.data.length;
  const totalRows = Math.ceil(total/cols);
  const totalHeight = totalRows * (ch + gap) - gap;
  gridInner.style.height = totalHeight+'px';

  const scrollTop = grid.scrollTop;
  const viewportH = grid.clientHeight;
  // render window
  const firstRow = Math.max(0, Math.floor(scrollTop / (ch+gap)) - 2);
  const lastRow = Math.min(totalRows-1, Math.floor((scrollTop+viewportH) / (ch+gap)) + 2);
  const firstIndex = firstRow * cols;
  const lastIndex  = Math.min(total-1, (lastRow+1)*cols - 1);

  // reuse: clear inner and append window cards
  gridInner.innerHTML='';
  for(let i=firstIndex;i<=lastIndex;i++){
    const it = state.data[i]; if(!it) continue;
    const row = Math.floor(i/cols); const col = i % cols;
    const x = col * (cw + gap); const y = row * (ch + gap);
    const d = document.createElement('div'); d.className='card'; d.style.transform=`translate(${x}px,${y}px)`; d.style.height=ch+'px'; d.setAttribute('data-id', it.id); d.setAttribute('data-rarity', it.r||'common'); d.setAttribute('draggable','true');
    d.addEventListener('dragstart',e=>e.dataTransfer.setData('text/plain',it.id));
    d.addEventListener('click',e=>selectByClick(it.id,d));

    const tag=document.createElement('div'); tag.className='tag'; tag.textContent=(it.r==='epic'?'–≠–ø–∏—á–µ—Å–∫–∏–π':(it.r==='rare'?'–†–µ–¥–∫–∏–π':'–û–±—ã—á–Ω—ã–π'));
    const emoji=document.createElement('div'); emoji.className='emoji'; emoji.textContent=it.e;
    const name=document.createElement('div'); name.className='name'; name.textContent=it.n;
    d.appendChild(tag); d.appendChild(emoji); d.appendChild(name);

    // fav toggle (right-click / long-press)
    d.addEventListener('contextmenu',(ev)=>{ ev.preventDefault(); toggleFav(it.id); });
    gridInner.appendChild(d);
  }
}
grid.addEventListener('scroll',()=>{ renderVirtual(); if(grid.scrollTop>grid.clientHeight) toTop.classList.add('fab','show'); else toTop.classList.remove('show'); });
addEventListener('resize',()=>renderVirtual());

/* ===== Carousels ===== */
function renderCarouselRow(container, arr){
  const A=ALL(); container.innerHTML='';
  arr.slice(0,24).forEach(id=>{
    if(!A.has(id)) return; const it=A.get(id);
    const pill=document.createElement('div'); pill.className='pill'; pill.setAttribute('data-id',id);
    pill.innerHTML=`<div class="emo">${it.e}</div><div class="nm">${it.n}</div>`;
    pill.addEventListener('click',()=> selectByClick(id,null));
    container.appendChild(pill);
  });
}
function toggleFav(id){ if(state.fav.has(id)) state.fav.delete(id); else state.fav.add(id); renderFav(); persist(); }
function renderFav(){ renderCarouselRow(favRow, [...state.fav]); }

/* ===== Selection & bowls ===== */
[bA,bB].forEach((b,ix)=>{ b.addEventListener('dragover',e=>e.preventDefault()); b.addEventListener('drop',e=>{e.preventDefault(); const id=e.dataTransfer.getData('text/plain'); if(!ALL().has(id))return; setToBowl(id,ix==0?'A':'B',null);});});
function bowlBlock(id){ if(!id) return '<div class="hint">–ü–µ—Ä–µ—Ç–∞—â–∏ –∏–ª–∏ –∫–ª–∏–∫–Ω–∏ –∫–∞—Ä—Ç–æ—á–∫—É</div>'; const it=ALL().get(id); return `<div class="selection"><div class="emoji">${it.e}</div><div class="name">${it.n}</div></div>`; }
function renderBowls(){ bA.innerHTML=bowlBlock(state.a); bB.innerHTML=bowlBlock(state.b); renderCrumbs(); }
function renderCrumbs(){ const parts=[]; if(state.a){ const it=ALL().get(state.a); parts.push(`<div class="token"><div class="emo">${it.e}</div></div>`);} if(state.b){ const it=ALL().get(state.b); parts.push(`<div class="token"><div class="emo">${it.e}</div></div>`);} crumbs.innerHTML=parts.join('')||'<div style="color:#9fb0bf;font-size:12px;padding:2px 6px">–í—ã–±–µ—Ä–∏ 2 —ç–ª–µ–º–µ–Ω—Ç–∞‚Ä¶</div>'; }
function selectByClick(id,node){ const target=!state.a?'A':(!state.b?'B':'A'); if(target==='A'&&state.a===id) return; if(target==='B'&&state.b===id) return; setToBowl(id,target,node); }
function setToBowl(id,which,node){ if(which==='A') state.a=id; else state.b=id; renderBowls(); persist();
  if(node){ const bowl=which==='A'?bA:bB; const targetEmoji=bowl.querySelector('.selection .emoji'); const em=node.querySelector('.emoji'); if(!(targetEmoji&&em)) return;
    const sr=em.getBoundingClientRect(), tr=targetEmoji.getBoundingClientRect(); const fly=document.createElement('div'); fly.className='fly'; fly.textContent=em.textContent; fly.style.fontSize=getComputedStyle(em).fontSize; fly.style.transform=`translate(${sr.left}px,${sr.top}px) scale(1)`; document.body.appendChild(fly);
    requestAnimationFrame(()=>{ const scale=parseFloat(getComputedStyle(targetEmoji).fontSize)/parseFloat(getComputedStyle(em).fontSize); fly.style.transform=`translate(${tr.left}px,${tr.top}px) scale(${scale})`;}); setTimeout(()=>fly.remove(),420);} }

/* ===== Hint / Stars ===== */
function updateStars(){ $('stars').textContent=state.stars; }
function nextFreeHintText(){ const now=Date.now(); const readyAt=(state.lastFreeHintAt||0)+HALF_DAY_MS; if(now>=readyAt) return '–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–∞'; const left=readyAt-now; const hh=String(Math.floor(left/3600000)).padStart(2,'0'); const mm=String(Math.floor((left%3600000)/60000)).padStart(2,'0'); const ss=String(Math.floor((left%60000)/1000)).padStart(2,'0'); return `–°–ª–µ–¥—É—é—â–∞—è –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è —á–µ—Ä–µ–∑: ${hh}:${mm}:${ss}`; }
function updateHintButton(){ const now=Date.now(); const freeReady= now>=(state.lastFreeHintAt||0)+HALF_DAY_MS; if(freeReady){ $('h1').textContent='–ü–æ–¥—Å–∫–∞–∑–∫–∞'; $('h2').textContent='–±–µ—Å–ø–ª–∞—Ç–Ω–æ'; } else { $('h1').textContent='–ö—É–ø–∏—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫—É'; $('h2').textContent='ü™ô 10'; } $('nextFreeText').textContent=nextFreeHintText(); }
setInterval(()=>{ $('nextFreeText').textContent=nextFreeHintText(); },1000);

function allPairsNew(){ const O=[...state.disc]; const R=REC(); const res=[]; for(let i=0;i<O.length;i++){ for(let j=i;j<O.length;j++){ const k=keyFor(O[i],O[j]); const out=R[k]; if(out && !state.disc.has(out)) res.push([O[i],O[j],out]); } } return res; }
function highlight(ids){ renderVirtual(); const nodes=gridInner.querySelectorAll('.card[data-id]'); nodes.forEach(n=>{ const id=n.getAttribute('data-id'); if(id && ids.includes(id)){ n.classList.add('pulse'); setTimeout(()=>n.classList.remove('pulse'),1600); } }); }
$('hint').addEventListener('click',()=>{
  const now=Date.now(); const freeReady= now>=(state.lastFreeHintAt||0)+HALF_DAY_MS;
  if(!freeReady && state.stars < HINT_COST){ toast('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç'); return; }
  const candidates=allPairsNew();
  if(candidates.length){ const [a,b] = candidates[0]; highlight([a,b]); toast(`–ü–æ–¥—Å–∫–∞–∑–∫–∞: ${nameOf(a)} + ${nameOf(b)} ‚Üí ?`); }
  else { toast('–ü–æ—Ö–æ–∂–µ, –Ω–æ–≤—ã—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏–π –±–æ–ª—å—à–µ –Ω–µ—Ç.'); }
  if(freeReady){ state.lastFreeHintAt=now; } else { state.stars -= HINT_COST; }
  updateHintButton(); updateStars(); persist();
});

/* ===== Craft ===== */
$('mix').addEventListener('click',()=>{
  if(!state.a||!state.b){ toast('–ù—É–∂–Ω–æ 2 —ç–ª–µ–º–µ–Ω—Ç–∞'); return; }
  const out=REC()[keyFor(state.a,state.b)]; if(!out){ toast('–ü—É—Å—Ç–∞—è —Ä–µ–∞–∫—Ü–∏—è‚Ä¶'); return; }
  const wasNew=!state.disc.has(out); state.disc.add(out); if(wasNew){ state.order=state.order.filter(x=>x!==out); state.order.push(out); }
  const it=ALL().get(out)||{e:'‚ú®',n:out,r:'common'};
  if(wasNew){
    state.journal.unshift({id:out,n:it.n,e:it.e,t:new Date().toISOString()});
    if(state.journal.length>500) state.journal.pop();
    // recent
    state.recent = [out, ...state.recent.filter(id=>id!==out)].slice(0,40);
    celebrateNew(out,it);
  } else {
    toast(`üß™ –ü–æ–ª—É—á–∏–ª–æ—Å—å: ${it.e} ${it.n}`);
  }
  state.a=null; state.b=null; renderBowls(); buildDataList(); renderVirtual(); renderRecent(); persist();
});

/* ===== Filters & mode ===== */
chipsEl.addEventListener('click',(e)=>{
  const chip=e.target.closest('.chip'); if(!chip) return;
  const type=chip.getAttribute('data-chip');
  // toggle logic
  if(['common','rare','epic'].includes(type)){
    state.filters.rarity = (state.filters.rarity===type)?null:type;
    // update chip visuals
    chipsEl.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
    if(state.filters.rarity) chipsEl.querySelector(`.chip[data-chip="${state.filters.rarity}"]`).classList.add('active');
    // preserve other toggles
    if(state.filters.isNew) chipsEl.querySelector(`.chip[data-chip="new"]`).classList.add('active');
    if(state.filters.fav) chipsEl.querySelector(`.chip[data-chip="fav"]`).classList.add('active');
  } else if(type==='new'){
    state.filters.isNew = !state.filters.isNew; chip.classList.toggle('active', state.filters.isNew);
  } else if(type==='fav'){
    state.filters.fav = !state.filters.fav; chip.classList.toggle('active', state.filters.fav);
  }
  buildDataList(); renderVirtual();
});
craftableToggle.addEventListener('click',()=>{
  state.filters.craftable = !state.filters.craftable;
  craftableToggle.classList.toggle('active', state.filters.craftable);
  buildDataList(); renderVirtual();
});

/* ===== Search / Reset ===== */
$('search').addEventListener('input',(()=>{ let t; return ()=>{ clearTimeout(t); t=setTimeout(()=>{ buildDataList(); renderVirtual(); },140); }; })());
$('reset').addEventListener('click',()=>{ localStorage.removeItem(SAVE_KEY); location.reload(); });

/* ===== Recent & Fav renderers ===== */
function renderRecent(){ renderCarouselRow(recentRow, state.recent); }
function renderFav(){ renderCarouselRow(favRow, [...state.fav]); }

/* ===== ToTop FAB ===== */
toTop.addEventListener('click',()=>{ grid.scrollTo({top:0, behavior:'smooth'}); });

/* ===== Init ===== */
function renderCrumbsInit(){ crumbs.innerHTML='<div style="color:#9fb0bf;font-size:12px;padding:2px 6px">–í—ã–±–µ—Ä–∏ 2 —ç–ª–µ–º–µ–Ω—Ç–∞‚Ä¶</div>'; }
function init(){ updateSoundBtn(); updateStars(); $('totalCount').textContent=MAX_ELEMENTS; renderBowls(); renderCrumbsInit(); updateHintButton(); renderRecent(); renderFav(); buildDataList(); renderVirtual(); }
init();

</script>
</body></html>
