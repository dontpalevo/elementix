<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Elementix ‚Äî Mini Alchemy (v1.7.3)</title>
<meta name="theme-color" content="#0b0e14">
<link rel="preconnect" href="https://telegram.org">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root{
  --bg:#0b0e14;--panel:#0f1420;--card:#0e121b;--text:#e6e9f2;--muted:#9aa3b2;
  --border:#223047;--accent:#7cc4ff;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444;
  --chip:#0f172a;--glass:rgba(255,255,255,.05);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:
    radial-gradient(1200px 800px at 10% -10%, #10233b 0%, transparent 60%),
    radial-gradient(800px 600px at 110% 30%, #1a2c44 0%, transparent 60%),
    linear-gradient(180deg, var(--bg), #0d1117 120%);
  color:var(--text);
  font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}
.wrap{max-width:820px;margin:0 auto;padding:10px calc(12px + env(safe-area-inset-right)) calc(150px + env(safe-area-inset-bottom)) calc(12px + env(safe-area-inset-left));display:grid;gap:12px}
header{
  position:sticky;top:0;z-index:50;backdrop-filter:saturate(120%) blur(8px);
  background:linear-gradient(180deg, rgba(2,6,23,.6), rgba(2,6,23,0));
  border-bottom:1px solid rgba(255,255,255,.04);
}
.hrow{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px 10px}
.brand{display:flex;align-items:center;gap:10px}
.logo{width:38px;height:38px;border-radius:12px;display:grid;place-items:center;background:conic-gradient(from 180deg at 60% 40%,#78d5ff, #7dffb6, #bda6ff, #78d5ff);filter:saturate(120%);position:relative}
.logo:after{content:"";position:absolute;inset:0;border-radius:12px;border:1px solid rgba(255,255,255,.15);box-shadow:inset 0 0 20px rgba(0,0,0,.25)}
.title{font-weight:900;letter-spacing:.3px}
.sub{opacity:.75;font-size:12px}
.pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:rgba(255,255,255,.04)}
.panel{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));border:1px solid var(--border);border-radius:16px;padding:12px;box-shadow:0 12px 30px rgba(0,0,0,.24)}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.grid{display:grid;gap:10px;grid-template-columns:repeat(2,1fr)}
@media (min-width:560px){ .grid{grid-template-columns:repeat(3,1fr)} }
@media (min-width:900px){ .grid{grid-template-columns:repeat(4,1fr)} }
.btn{appearance:none;border:none;cursor:pointer;
  padding:12px 14px;border-radius:12px;min-height:44px;
  background:linear-gradient(180deg,#111827,#0d1522);color:var(--text);
  border:1px solid var(--border);transition:transform .08s ease, background .2s, opacity .2s;user-select:none}
.btn:active{transform:translateY(1px)}
.btn.ghost{background:transparent}
.btn.success{background:linear-gradient(180deg,#22c55e,#16a34a)}
.btn.warn{background:linear-gradient(180deg,#f59e0b,#d97706)}
.btn.icon{width:40px;height:40px;display:grid;place-items:center;padding:0;border-radius:10px}
input[type="search"]{
  flex:1;min-width:180px;padding:11px;border-radius:10px;
  border:1px solid var(--border);background:#0b0f18;color:var(--text)
}
.card{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:14px;cursor:pointer;position:relative;
  background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));
  border:1px solid var(--border);min-height:56px;overflow:hidden}
.card:hover{outline:1px solid rgba(124,196,255,.25)}
.card:active{transform:translateY(1px)}
.emoji{font-size:22px;flex:0 0 auto}
.name{font-weight:800;letter-spacing:.2px}
.rar{position:absolute;right:8px;top:8px;font-size:10px;opacity:.7;border:1px solid var(--border);padding:2px 6px;border-radius:999px}
.bowls{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.bowl{min-height:90px;border:1px dashed #2a3a56;border-radius:14px;display:flex;align-items:center;justify-content:center;padding:12px;background:#0f1320;color:#9fb3c8;position:relative;text-align:center}
.chip{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:var(--chip);border:1px solid var(--border);font-weight:700}
.empty{padding:18px;border:1px dashed var(--border);border-radius:12px;text-align:center;color:var(--muted)}
.toast{position:fixed;left:50%;top:10px;transform:translateX(-50%);background:#0f1420;border:1px solid var(--border);border-radius:10px;padding:8px 12px;display:none;z-index:200}
.toast.show{display:block}
.badge{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.04);font-size:12px}

/* action dock ‚Äî wide pill with grid */
.dock{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(78px + env(safe-area-inset-bottom));z-index:55;
  display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:center;
  background:rgba(6,10,18,.7);backdrop-filter:blur(10px) saturate(120%);
  border:1px solid var(--border);padding:10px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35);width:min(92vw,720px)}
.dock .btn{width:100%}
@media (max-width:360px){ .dock{grid-template-columns:1fr;row-gap:8px} } /* –Ω–∞ –æ—á–µ–Ω—å —É–∑–∫–∏—Ö ‚Äî –≤ —Å—Ç–æ–ª–±–∏–∫ */

/* floating hint ‚Äî lifted and clamped */
.fab-hint{position:fixed;left:14px;bottom:calc(78px + env(safe-area-inset-bottom) + 66px);z-index:56;
  display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:14px;border:1px solid var(--border);
  background:linear-gradient(180deg,#1b2434,#0f1420);box-shadow:0 8px 24px rgba(0,0,0,.35);max-width:60vw}
.fab-hint .bulb{width:24px;height:24px;border-radius:7px;display:grid;place-items:center;background:linear-gradient(180deg,#eab308,#f59e0b);box-shadow:0 0 16px rgba(245,158,11,.35)}
.fab-hint .txt{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* footer reset */
footer{position:fixed;left:0;right:0;bottom:0;padding:8px 12px calc(8px + env(safe-area-inset-bottom));display:flex;justify-content:center;background:linear-gradient(180deg, transparent, rgba(2,6,23,.6));z-index:50}
.reset-wrap{display:flex;gap:10px;align-items:center;border:1px dashed var(--border);background:rgba(255,255,255,.02);padding:8px 10px;border-radius:12px}
.devnote{opacity:.8;font-size:12px}

/* modal */
.modal{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.4);z-index:300}
.modal.show{display:flex}
.sheet{width:100%;max-width:820px;background:#0f1420;border:1px solid var(--border);border-radius:18px 18px 0 0;padding:14px 14px 24px;box-shadow:0 -10px 30px rgba(0,0,0,.35)}
.sheet h3{margin:0 0 8px}
.sheet .opt{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border);border-radius:14px;padding:12px;margin-top:10px;background:rgba(255,255,255,.02)}
.sheet .opt small{opacity:.7}
.sheet .opt .btn{min-width:110px}

/* hint pretty */
.hint-card{border:1px solid var(--border);background:radial-gradient(1000px 500px at -20% -50%,rgba(124,196,255,.12),transparent 60%),rgba(255,255,255,.02);padding:12px;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
.hint-row{display:flex;align-items:center;gap:10px;flex-wrap:nowrap;overflow:auto}
.hint-row .eq{opacity:.6;margin:0 4px}
.hint-head{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.hint-bulb{width:28px;height:28px;border-radius:8px;display:grid;place-items:center;background:linear-gradient(180deg,#eab308,#f59e0b);box-shadow:0 0 16px rgba(245,158,11,.35)}
.center{display:flex;justify-content:center;margin-top:10px}
</style>
</head>
<body>
<header>
  <div class="hrow">
    <div class="brand">
      <div class="logo"></div>
      <div>
        <div class="title">Elementix</div>
        <div class="sub" id="tgUser">–ò–≥—Ä–æ–∫: ... ¬∑ <span class="version">v1.7.3</span></div>
      </div>
    </div>
    <div class="row">
      <span class="pill">‚≠ê <b id="stars">0</b></span>
      <button class="btn ghost" id="btnShop">–ú–∞–≥–∞–∑–∏–Ω</button>
      <button class="btn icon" id="btnShare" title="–ü–æ–¥–µ–ª–∏—Ç—å—Å—è">üîó</button>
    </div>
  </div>
</header>

<main class="wrap" id="root">

  <section class="panel">
    <div class="row" style="justify-content:space-between;gap:8px">
      <div class="row">
        <button class="btn ghost" id="btnQuests">–ó–∞–¥–∞–Ω–∏—è</button>
      </div>
      <small id="themeDbg" class="sub"></small>
    </div>
  </section>

  <section class="panel">
    <div class="bowls">
      <div class="bowl" id="bowlA"><span class="sub">–í—ã–±–µ—Ä–∏ —ç–ª–µ–º–µ–Ω—Ç‚Ä¶</span></div>
      <div class="bowl" id="bowlB"><span class="sub">‚Ä¶–∏ –≤—Ç–æ—Ä–æ–π</span></div>
    </div>
  </section>

  <section class="panel">
    <div class="row" style="justify-content:space-between;gap:10px">
      <div class="pill">–û—Ç–∫—Ä—ã—Ç–æ: <b id="discCount">0</b> / <b id="totalCount">0</b></div>
      <input id="search" type="search" placeholder="–ü–æ–∏—Å–∫">
    </div>
    <div class="grid" id="cards" style="margin-top:10px"></div>
    <div id="emptyState" class="empty" style="display:none">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
  </section>

</main>

<!-- Action Dock -->
<div class="fab-hint" id="fabHint"><div class="bulb">üí°</div><div class="txt">–ü–æ–¥—Å–∫–∞–∑–∫–∞</div></div>
<div class="dock">
  <button class="btn success" id="btnMixDock">ü•£ –°–º–µ—à–∞—Ç—å</button>
  <button class="btn" id="btnClearDock">üßπ –û—á–∏—Å—Ç–∏—Ç—å</button>
</div>

<footer>
  <div class="reset-wrap">
    <button class="btn" id="btnReset">–°–±—Ä–æ—Å</button>
    <span class="devnote">–∫—Ç–æ –Ω–∞–∂–º—ë—Ç ‚Äî –º–∏–Ω—É—Å –º–∞—Ç—å</span>
  </div>
</footer>

<div id="toast" class="toast"></div>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="sheet" id="sheet"></div>
</div>

<script>
/* ---------- Telegram WebApp & Theme ---------- */
const tg = window.Telegram?.WebApp;
if (tg){
  tg.ready(); tg.expand();
  applyTheme(tg.themeParams);
  tg.onEvent('themeChanged', ()=> applyTheme(tg.themeParams));
}
function applyTheme(p){
  if(!p) return; const css = document.documentElement.style;
  if (p.bg_color) css.setProperty('--bg', p.bg_color);
  if (p.secondary_bg_color) css.setProperty('--panel', p.secondary_bg_color);
  if (p.text_color) css.setProperty('--text', p.text_color);
  if (p.hint_color) css.setProperty('--muted', p.hint_color);
  if (p.link_color) css.setProperty('--accent', p.link_color);
  if (p.button_color) css.setProperty('--border', p.button_color + '40');
  document.getElementById('themeDbg').textContent = tg?.colorScheme ? ('theme: ' + tg.colorScheme) : '';
}

/* ---------- Elements & Recipes (same subset) ---------- */
const E = (id, name, emoji, rar='Common') => ({id,name,emoji,rar});
const ELEMENTS=[
  E('air','–í–æ–∑–¥—É—Ö','üí®'), E('earth','–ó–µ–º–ª—è','üå±'), E('fire','–û–≥–æ–Ω—å','üî•'), E('water','–í–æ–¥–∞','üíß'),
  E('steam','–ü–∞—Ä','‚ô®Ô∏è'), E('stone','–ö–∞–º–µ–Ω—å','ü™®'), E('dust','–ü—ã–ª—å','üå´Ô∏è'), E('lava','–õ–∞–≤–∞','üåã','Uncommon'),
  E('energy','–≠–Ω–µ—Ä–≥–∏—è','‚ö°','Uncommon'), E('rain','–î–æ–∂–¥—å','üåßÔ∏è'), E('mud','–ì—Ä—è–∑—å','üü´'),
  E('sand','–ü–µ—Å–æ–∫','üèñÔ∏è'), E('glass','–°—Ç–µ–∫–ª–æ','üß™','Uncommon'), E('metal','–ú–µ—Ç–∞–ª–ª','üõ†Ô∏è','Uncommon'),
  E('electricity','–≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ','üîå','Rare'), E('sea','–ú–æ—Ä–µ','üåä'), E('ocean','–û–∫–µ–∞–Ω','üåä','Uncommon'),
  E('river','–†–µ–∫–∞','üèûÔ∏è'), E('lake','–û–∑–µ—Ä–æ','üõ∂'), E('plant','–†–∞—Å—Ç–µ–Ω–∏–µ','üåø'), E('tree','–î–µ—Ä–µ–≤–æ','üå≥','Uncommon'),
  E('coal','–£–≥–æ–ª—å','ü™µ'), E('oil','–ù–µ—Ñ—Ç—å','üõ¢Ô∏è','Uncommon'), E('pressure','–î–∞–≤–ª–µ–Ω–∏–µ','üéõÔ∏è'),
  E('time','–í—Ä–µ–º—è','‚è≥','Rare'), E('life','–ñ–∏–∑–Ω—å','üß¨','Epic'),
  E('bacteria','–ë–∞–∫—Ç–µ—Ä–∏—è','ü¶†'), E('fish','–†—ã–±–∞','üêü'), E('animal','–ñ–∏–≤–æ—Ç–Ω–æ–µ','üêæ','Uncommon'),
  E('bird','–ü—Ç–∏—Ü–∞','üê¶'), E('human','–ß–µ–ª–æ–≤–µ–∫','üßç','Rare'),
  E('tool','–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç','ü™ì'), E('wheel','–ö–æ–ª–µ—Å–æ','üõû'), E('cart','–¢–µ–ª–µ–≥–∞','üõí'),
  E('sandstorm','–ü–µ—Å—á–∞–Ω–∞—è –±—É—Ä—è','üå™Ô∏è'), E('storm','–®—Ç–æ—Ä–º','üå™Ô∏è','Uncommon'),
  E('cloud','–û–±–ª–∞–∫–æ','‚òÅÔ∏è'), E('sky','–ù–µ–±–æ','üåå'), E('sun','–°–æ–ª–Ω—Ü–µ','‚òÄÔ∏è','Uncommon'), E('moon','–õ—É–Ω–∞','üåô','Uncommon'),
  E('brick','–ö–∏—Ä–ø–∏—á','üß±'), E('house','–î–æ–º','üè†','Uncommon'), E('city','–ì–æ—Ä–æ–¥','üèôÔ∏è','Rare'),
  E('computer','–ö–æ–º–ø—å—é—Ç–µ—Ä','üíª','Epic'), E('electricity_gen','–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä','üîã','Uncommon'),
  E('sandglass','–ü–µ—Å–æ—á–Ω—ã–µ —á–∞—Å—ã','‚åõ','Uncommon'), E('glass_sandwich','–°—Ç–µ–∫–ª–æ–ø–∞–∫–µ—Ç','ü™ü','Uncommon'),
  E('ash','–ü–µ–ø–µ–ª','üß´'), E('smoke','–î—ã–º','üí®','Uncommon'), E('alcohol','–ê–ª–∫–æ–≥–æ–ª—å','üç∑','Uncommon'),
  E('bread','–•–ª–µ–±','üçû'), E('dough','–¢–µ—Å—Ç–æ','ü•ñ'), E('flour','–ú—É–∫–∞','üåæ'),
  E('energy_drink','–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫','ü•§','Rare'), E('robot','–†–æ–±–æ—Ç','ü§ñ','Epic')
];
const R = (...a)=>a.sort().join('|');
const RECIPES = new Map([
  [R('fire','water'),'steam'], [R('air','earth'),'dust'], [R('earth','water'),'mud'],
  [R('fire','earth'),'lava'], [R('air','water'),'rain'], [R('rain','earth'),'plant'],
  [R('plant','time'),'tree'], [R('pressure','plant'),'coal'], [R('time','coal'),'oil'],
  [R('water','water'),'sea'], [R('sea','sea'),'ocean'], [R('sand','fire'),'glass'],
  [R('stone','fire'),'metal'], [R('energy','metal'),'electricity'], [R('air','sand'),'sandstorm'],
  [R('steam','air'),'cloud'], [R('cloud','air'),'sky'],
  [R('plant','water'),'algae'], [R('algae','time'),'bacteria'], [R('bacteria','water'),'fish'],
  [R('fish','time'),'animal'], [R('animal','time'),'human'], [R('human','tool'),'house'],
  [R('brick','brick'),'wall'], [R('sand','pressure'),'stone'], [R('lava','water'),'stone'],
  [R('glass','air'),'glass_sandwich'], [R('sand','time'),'sandglass'], [R('fire','plant'),'ash'],
  [R('fire','air'),'smoke'], [R('plant','tool'),'flour'], [R('flour','water'),'dough'],
  [R('dough','fire'),'bread'], [R('energy','water'),'energy_drink'],
  [R('electricity','metal'),'computer'], [R('energy','metal'),'electricity_gen'],
  [R('electricity','tool'),'robot']
]);

/* ---------- State ---------- */
const state={
  discovered:new Set(['air','earth','fire','water']),
  bowlA:null,bowlB:null,stars:0,user:'–ì–æ—Å—Ç—å',
  lastFreeHint:0,
  quests:{ mix10:false, open5:false, visitDaily:false },
  stats:{ mixes:0, opens:0, lastVisit:0 }
};

/* ---------- Identity ---------- */
(function initIdentity(){
  const u=tg?.initDataUnsafe?.user;
  state.user = u?.username || u?.first_name || '–ì–æ—Å—Ç—å';
  document.getElementById('tgUser').innerHTML = `–ò–≥—Ä–æ–∫: ${state.user} ¬∑ <span class="version">v1.7.3</span>`;
})();

/* ---------- DOM ---------- */
const cardsEl=document.getElementById('cards');
const bowlA=document.getElementById('bowlA');
const bowlB=document.getElementById('bowlB');
const discCount=document.getElementById('discCount');
const totalCount=document.getElementById('totalCount');
const starsEl=document.getElementById('stars');
const searchEl=document.getElementById('search');
const toastEl=document.getElementById('toast');
const emptyState=document.getElementById('emptyState');
const modal=document.getElementById('modal');
const sheet=document.getElementById('sheet');

/* ---------- Helpers ---------- */
const elemById = id => ELEMENTS.find(e=>e.id===id);
function chipHTML(id){ const e=elemById(id); return e?`<span class="chip"><span style="font-size:18px">${e.emoji}</span><b>${e.name}</b></span>`:''; }
function k(a,b){ return a<b?`${a}|${b}`:`${b}|${a}` }
function toast(m){ toastEl.textContent=m; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'),1400); tg?.HapticFeedback?.notificationOccurred('success'); }
function openModal(inner){ sheet.innerHTML=inner; modal.classList.add('show'); modal.onclick=(e)=>{ if(e.target===modal) modal.classList.remove('show'); } }
function fmtTimeLeft(ms){ const s=Math.max(0,Math.ceil(ms/1000)); const h=Math.floor(s/3600), m=Math.floor((s%3600)/60); const ss=s%60; return `${h}—á ${m}–º ${ss}—Å`; }

/* ---------- Render ---------- */
function render(){
  totalCount.textContent = ELEMENTS.length;
  const q=(searchEl.value||'').toLowerCase();
  const items=ELEMENTS.filter(e=>state.discovered.has(e.id) && (!q || e.name.toLowerCase().includes(q)));
  cardsEl.innerHTML=items.map(e=>`<div class="card" data-id="${e.id}"><span class="emoji">${e.emoji}</span><span class="name">${e.name}</span><span class="rar">${e.rar}</span></div>`).join('');
  document.querySelectorAll('.card').forEach(c=>c.addEventListener('click',()=> pickToBowl(c.dataset.id)));
  bowlA.innerHTML = state.bowlA ? chipHTML(state.bowlA) : '<span class="sub">–í—ã–±–µ—Ä–∏ —ç–ª–µ–º–µ–Ω—Ç‚Ä¶</span>';
  bowlB.innerHTML = state.bowlB ? chipHTML(state.bowlB) : '<span class="sub">‚Ä¶–∏ –≤—Ç–æ—Ä–æ–π</span>';
  discCount.textContent = state.discovered.size;
  starsEl.textContent = state.stars;
  emptyState.style.display = items.length? 'none':'block';
}

/* ---------- Actions ---------- */
function pickToBowl(id){ if (!state.bowlA) state.bowlA=id; else state.bowlB=id; render(); tg?.HapticFeedback?.impactOccurred('light'); }
function selectNone(){ state.bowlA=state.bowlB=null; render(); }
function doMix(){
  const a=state.bowlA,b=state.bowlB; if(!a||!b){ toast('–ù—É–∂–Ω–æ 2 —ç–ª–µ–º–µ–Ω—Ç–∞'); return; }
  state.stats.mixes++;
  const result=RECIPES.get(k(a,b));
  selectNone();
  if(!result){ toast('–ù–µ –≤—ã—à–ª–æ'); saveProgressDebounced(); checkQuests(); return; }
  const wasNew=!state.discovered.has(result);
  state.discovered.add(result);
  if (wasNew){ state.stars+=2; state.stats.opens++; toast('–ù–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç! +2 ‚≠ê'); }
  render();
  saveProgressDebounced(); checkQuests();
}

/* ---------- Hints ---------- */
const FREE_HINT_COOLDOWN = 8*60*60*1000; // 8h
const HINT_PRICE = 5; // stars

function showHintModal(){
  const now = Date.now();
  const next = state.lastFreeHint + FREE_HINT_COOLDOWN;
  const canFree = now >= next;
  const left = next - now;
  const inner = `
    <div class="hint-head"><div class="hint-bulb">üí°</div><h3 style="margin:0">–ü–æ–¥—Å–∫–∞–∑–∫–∏</h3></div>
    <div class="opt">
      <div><b>–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è</b><br><small>${canFree ? '–î–æ—Å—Ç—É–ø–Ω–∞ —Å–µ–π—á–∞—Å' : '–ß–µ—Ä–µ–∑ ' + fmtTimeLeft(left)}</small></div>
      <button class="btn success" id="freeHintBtn" ${canFree?'':'disabled'}>–ü–æ–ª—É—á–∏—Ç—å</button>
    </div>
    <div class="opt">
      <div><b>–ü–ª–∞—Ç–Ω–∞—è</b><br><small>–°—Ç–æ–∏—Ç ${HINT_PRICE}‚≠ê ‚Ä¢ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤–æ–∑–º–æ–∂–Ω—ã–π —Ä–µ—Ü–µ–ø—Ç</small></div>
      <button class="btn" id="paidHintBtn">–ö—É–ø–∏—Ç—å</button>
    </div>
    <div class="hint-card" id="hintArea" style="display:none">
      <div class="hint-row" id="hintRow"></div>
      <div class="center"><button class="btn success" id="okHint">–û–∫–µ–π</button></div>
    </div>
  `;
  openModal(inner);
  document.getElementById('freeHintBtn')?.addEventListener('click', ()=> useHint(true));
  document.getElementById('paidHintBtn')?.addEventListener('click', ()=> useHint(false));
}

function useHint(isFree){
  if (isFree){
    const now=Date.now();
    if (now < state.lastFreeHint + FREE_HINT_COOLDOWN) return;
    state.lastFreeHint = now;
  } else {
    if (state.stars < HINT_PRICE){ toast('–ú–∞–ª–æ ‚≠ê'); showShop(); return; }
    state.stars -= HINT_PRICE;
  }
  const hint = getHint();
  if (!hint){ toast('–ü–æ—Ö–æ–∂–µ, –≤—Å—ë –æ—Ç–∫—Ä—ã—Ç–æ!'); modal.classList.remove('show'); render(); saveProgressDebounced(); return; }
  const [a,b,res] = hint;
  const row = document.getElementById('hintRow');
  row.innerHTML = `${chipHTML(a)} <span class="eq">+</span> ${chipHTML(b)} <span class="eq">‚Üí</span> ${chipHTML(res)}`;
  document.getElementById('hintArea').style.display='block';
  document.getElementById('okHint').onclick = ()=>{ modal.classList.remove('show'); render(); saveProgressDebounced(); };
  render(); saveProgressDebounced();
}

function getHint(){
  for (const [key,res] of RECIPES){
    const [a,b] = key.split('|');
    if (!state.discovered.has(res) && state.discovered.has(a) && state.discovered.has(b)){
      return [a,b,res];
    }
  }
  return null;
}

/* ---------- Shop ---------- */
function showShop(){
  const inner = `
    <h3>–ú–∞–≥–∞–∑–∏–Ω ‚≠ê</h3>
    <div class="opt"><div><b>10 ‚≠ê</b><br><small>–ú–∞–ª—ã–π –Ω–∞–±–æ—Ä</small></div><button class="btn" data-pack="10">–ü–æ–ª—É—á–∏—Ç—å</button></div>
    <div class="opt"><div><b>30 ‚≠ê</b><br><small>–°—Ä–µ–¥–Ω–∏–π –Ω–∞–±–æ—Ä</small></div><button class="btn" data-pack="30">–ü–æ–ª—É—á–∏—Ç—å</button></div>
    <div class="opt"><div><b>80 ‚≠ê</b><br><small>–ë–æ–ª—å—à–æ–π –Ω–∞–±–æ—Ä</small></div><button class="btn" data-pack="80">–ü–æ–ª—É—á–∏—Ç—å</button></div>
    <div class="opt"><div><b>–°–º–æ—Ç—Ä–µ—Ç—å —Ä–æ–ª–∏–∫</b><br><small>+3 ‚≠ê –∑–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä (—ç–º—É–ª—è—Ü–∏—è)</small></div><button class="btn warn" id="watch">‚ñ∂Ô∏è</button></div>
    <div class="opt"><div class="badge">–í–∞—à –±–∞–ª–∞–Ω—Å: ‚≠ê <b id="balance">${state.stars}</b></div><button class="btn ghost" id="closeShop">–ó–∞–∫—Ä—ã—Ç—å</button></div>
  `;
  openModal(inner);
  sheet.querySelectorAll('button[data-pack]').forEach(btn=> btn.onclick = ()=>{
    const n=parseInt(btn.dataset.pack,10); state.stars+=n; render(); saveProgressDebounced(); showShop();
  });
  document.getElementById('watch').onclick = ()=>{ state.stars+=3; toast('+3 ‚≠ê'); render(); saveProgressDebounced(); showShop(); };
  document.getElementById('closeShop').onclick = ()=> modal.classList.remove('show');
}

/* ---------- Quests & Achievements ---------- */
function showQuests(){
  const doneMix10 = state.stats.mixes>=10;
  const doneOpen5 = state.stats.opens>=5;
  const today = new Date(); today.setHours(0,0,0,0);
  const visitedToday = state.stats.lastVisit >= today.getTime();

  const inner = `
    <h3>–ó–∞–¥–∞–Ω–∏—è</h3>
    <div class="opt">
      <div><b>–°–¥–µ–ª–∞–π 10 —Å–º–µ—à–∏–≤–∞–Ω–∏–π</b><br><small>${state.stats.mixes}/10</small></div>
      <button class="btn ${state.quests.mix10?'ghost':'success'}" id="q1">${doneMix10&&!state.quests.mix10?'–ó–∞–±—Ä–∞—Ç—å 5‚≠ê': (state.quests.mix10?'–í—ã–ø–æ–ª–Ω–µ–Ω–æ':'–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ')}</button>
    </div>
    <div class="opt">
      <div><b>–û—Ç–∫—Ä–æ–π 5 –Ω–æ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤</b><br><small>${state.stats.opens}/5</small></div>
      <button class="btn ${state.quests.open5?'ghost':'success'}" id="q2">${doneOpen5&&!state.quests.open5?'–ó–∞–±—Ä–∞—Ç—å 8‚≠ê': (state.quests.open5?'–í—ã–ø–æ–ª–Ω–µ–Ω–æ':'–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ')}</button>
    </div>
    <div class="opt">
      <div><b>–ó–∞–π–¥–∏ —Å–µ–≥–æ–¥–Ω—è</b><br><small>${visitedToday?'–°–µ–≥–æ–¥–Ω—è':'–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ'}</small></div>
      <button class="btn ${state.quests.visitDaily?'ghost':'success'}" id="q3">${visitedToday&&!state.quests.visitDaily?'–ó–∞–±—Ä–∞—Ç—å 3‚≠ê': (state.quests.visitDaily?'–í—ã–ø–æ–ª–Ω–µ–Ω–æ':'–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ')}</button>
    </div>
    <div class="opt"><div class="badge">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Å—á–∏—Ç–∞—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ ‚Ä¢ –æ–±–Ω–æ–≤—è—Ç—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –∑–∞–ø—É—Å–∫–µ</div><button class="btn ghost" id="closeQuests">–ó–∞–∫—Ä—ã—Ç—å</button></div>
  `;
  openModal(inner);
  document.getElementById('q1').onclick = ()=>{ if(doneMix10 && !state.quests.mix10){ state.quests.mix10=true; state.stars+=5; render(); saveProgressDebounced(); showQuests(); } };
  document.getElementById('q2').onclick = ()=>{ if(doneOpen5 && !state.quests.open5){ state.quests.open5=true; state.stars+=8; render(); saveProgressDebounced(); showQuests(); } };
  document.getElementById('q3').onclick = ()=>{ if(visitedToday && !state.quests.visitDaily){ state.quests.visitDaily=true; state.stars+=3; render(); saveProgressDebounced(); showQuests(); } };
  document.getElementById('closeQuests').onclick = ()=> modal.classList.remove('show');
}

function checkQuests(){
  const today = new Date(); today.setHours(0,0,0,0);
  if (Date.now() > today.getTime() && state.stats.lastVisit < today.getTime()){
    state.stats.lastVisit = Date.now();
  }
}

/* ---------- Persistence ---------- */
const LS_KEY='elementix_v173_progress';
function loadLocal(){
  try{ const j=JSON.parse(localStorage.getItem(LS_KEY)); if(j){
    state.discovered=new Set(j.discovered||['air','earth','fire','water']);
    state.stars=j.stars||0; state.lastFreeHint=j.lastFreeHint||0;
    state.quests=j.quests||state.quests; state.stats=j.stats||state.stats;
  }}catch{}
}
function saveLocal(){
  try{ localStorage.setItem(LS_KEY, JSON.stringify({
    discovered:[...state.discovered], stars:state.stars, lastFreeHint:state.lastFreeHint,
    quests:state.quests, stats:state.stats
  })); }catch{}
}

async function tryServerLoad(){
  if (!tg?.initData) return null;
  try{
    const r=await fetch('/api/load',{headers:{'X-Telegram-Init-Data':tg.initData}});
    if(!r.ok) return null;
    const json=await r.json();
    if(json?.ok && json.data){
      const d=json.data;
      if (Array.isArray(d.discovered)) state.discovered=new Set(d.discovered);
      if (typeof d.stars==='number') state.stars=d.stars;
      if (typeof d.lastFreeHint==='number') state.lastFreeHint=d.lastFreeHint;
      if (d.quests) state.quests=d.quests;
      if (d.stats) state.stats=d.stats;
      return true;
    }
  }catch(e){}
  return null;
}
async function tryServerSave(){
  if (!tg?.initData) return null;
  try{
    const r=await fetch('/api/save',{
      method:'POST',
      headers:{'Content-Type':'application/json','X-Telegram-Init-Data':tg.initData},
      body:JSON.stringify({discovered:[...state.discovered],stars:state.stars,lastFreeHint:state.lastFreeHint,quests:state.quests,stats:state.stats})
    });
    return r.ok;
  }catch(e){ return null; }
}
const saveProgressDebounced = debounce(()=>{ saveLocal(); tryServerSave(); }, 250);
function debounce(fn,ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); } }

/* ---------- Events ---------- */
document.getElementById('btnMixDock').onclick=doMix;
document.getElementById('btnClearDock').onclick=selectNone;
document.getElementById('fabHint').onclick=showHintModal;

document.getElementById('btnReset').onclick=()=>{
  if(confirm('–°–±—Ä–æ—Å–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å?')){
    state.discovered=new Set(['air','earth','fire','water']); state.stars=0; state.stats.mixes=0; state.stats.opens=0;
    toast('–°–±—Ä–æ—à–µ–Ω–æ'); selectNone(); render(); saveProgressDebounced();
  }
};
document.getElementById('btnShare').onclick=()=>{
  const url=(location.origin+location.pathname).replace(/#.*$/,'');
  const text=encodeURIComponent('–û—Ç–∫—Ä—ã–ª –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –≤ Elementix!');
  const share=`https://t.me/share/url?url=${encodeURIComponent(url)}&text=${text}`;
  if (tg) tg.openTelegramLink(share); else window.open(share,'_blank');
};
document.getElementById('btnShop').onclick=showShop;
document.getElementById('btnQuests').onclick=showQuests;
document.getElementById('search').oninput=render;

/* ---------- Init ---------- */
(async function init(){
  loadLocal();
  await tryServerLoad();
  render();
  state.stats.lastVisit = Date.now();
  saveProgressDebounced();
})();
</script>
</body>
</html>