<!doctype html>
<html lang="ru"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1">
<title>Elementix ‚Äî –∞–ª—Ö–∏–º–∏—è</title>
<meta name="color-scheme" content="dark"><meta name="theme-color" content="#0b0f14">
<style>
:root{--bg:#0b0f14;--panel:#10161d;--line:#1f2a39;--ink:#e7ecf4;--muted:#9fb0bf;--accent:#6fb1ff;--gold:#ffd166;--success:#8aff9c}
*{box-sizing:border-box}html,body{height:100%;margin:0;color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans",sans-serif}
body{background:radial-gradient(800px 480px at 80% -10%, #182335, #0b0f14)}
.app{min-height:100%;display:flex;flex-direction:column}

/* header */
.header{position:sticky;top:0;z-index:80;display:flex;align-items:center;gap:10px;height:48px;padding:0 12px;border-bottom:1px solid var(--line);background:rgba(11,15,20,.98)}
.title{font-weight:800}.spacer{flex:1}
.gold{display:flex;align-items:center;gap:8px;background:#121b28;border:1px solid #253247;color:var(--gold);border-radius:999px;padding:6px 12px;font-weight:800}
.soundBtn{background:#162030;border:1px solid #223247;border-radius:10px;color:#cfe1ff;padding:6px 10px;cursor:pointer;display:flex;align-items:center;gap:6px}

/* crumbs under header */
.crumbs{position:sticky;top:48px;z-index:75;display:flex;gap:10px;align-items:center;overflow-x:auto;padding:8px 6px;background:rgba(11,15,20,.98);border-bottom:1px solid var(--line)}
.token{display:grid;place-items:center;width:42px;height:42px;border-radius:50%;background:linear-gradient(180deg,#0f1620,#0b1218);border:1px solid #203043;box-shadow:0 6px 18px rgba(0,0,0,.25)}.token .emo{font-size:22px}

/* main area */
.main{display:flex;flex-direction:column;gap:10px;padding:8px 12px calc(170px + env(safe-area-inset-bottom,0px))}

/* bowls */
.bowls{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.drop{position:relative;background:#0b1218;border:1px dashed #2a384b;border-radius:16px;min-height:140px;display:grid;place-items:center;overflow:hidden}
.drop .hint{position:absolute;top:8px;left:12px;color:var(--muted);font-size:12px}
.selection{display:flex;gap:12px;align-items:center;animation:arrive .32s ease-out}
.selection .emoji{font-size:56px;filter:drop-shadow(0 8px 14px rgba(0,0,0,.35))}
.selection .name{font-size:14px;color:#d7e8ff}
@keyframes arrive{0%{transform:translateY(10px) scale(.9);opacity:0}100%{transform:translateY(0) scale(1);opacity:1}}

/* tools */
.tools{position:sticky;top:calc(48px + 56px);z-index:70;background:rgba(11,15,20,.98);border:1px solid #1b2a3a;border-radius:12px;padding:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;transition:transform .22s ease, opacity .22s ease}
.tools input{flex:1;background:#0b1218;border:1px solid var(--line);border-radius:10px;color:#cfe1ff;padding:10px}.count{font-size:12px;color:#9fb0bf}
.btn{background:#1b2633;border:1px solid #253247;color:#cfe1ff;border-radius:14px;padding:10px 12px;font-weight:700;cursor:pointer}
.btn.primary{background:#6fb1ff;border:none;color:#07101c;font-weight:900;padding:12px 18px;border-radius:18px;font-size:16px}

/* chips row (rarity) */
.chips{display:flex;gap:8px;overflow:auto;padding:6px 2px}
.chip{background:#111a23;border:1px solid #223247;color:#cfe1ff;border-radius:999px;padding:6px 10px;font-size:12px;white-space:nowrap;cursor:pointer}
.chip.active{background:#6fb1ff;color:#07101c;border-color:#6fb1ff;font-weight:900}

/* grid */
.gridWrap{border:1px solid #1b2735;border-radius:12px;background:linear-gradient(180deg,#0d141c,#0a0f15)}
#grid{position:relative;height:560px;overflow:auto}
.gridInner{position:relative}
.card{position:absolute;width:calc(25% - 12px);background: linear-gradient(180deg, #101821, #0b1218); border: 1px solid #1b2735; border-radius: 14px; padding: 10px; display: grid; gap: 6px; cursor: grab; box-shadow: 0 6px 18px rgba(0,0,0,.22); transition: transform .08s ease, box-shadow .12s ease, border-color .12s ease}
.card:hover{ transform: translateY(-2px); box-shadow: 0 12px 26px rgba(0,0,0,.32); border-color: #263547; }
.emoji{ font-size: 30px; text-shadow: 0 6px 12px rgba(0,0,0,.35) }
.name{ font-size: 12px; color: #cfe1ff }
.tag{ position: absolute; top: 8px; right: 8px; font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 999px; background: #121b28; border: 1px solid #253247; color: #9fb0bf; }
.card[data-rarity="common"] .tag{ background: rgba(173,186,200,.12); border-color: rgba(173,186,200,.30); color: #b9c6d3 }
.card[data-rarity="rare"]   .tag{ background: rgba(111,177,255,.14); border-color: rgba(111,177,255,.32); color: #9dccff }
.card[data-rarity="epic"]   .tag{ background: rgba(255,209,102,.14); border-color: rgba(255,209,102,.36); color: #ffd166 }
.card.glow{box-shadow:0 0 0 3px rgba(111,177,255,.6), 0 0 20px rgba(111,177,255,.45); border-color:#6fb1ff; transform:translateZ(0) scale(1.02)}
@keyframes hintBlink{0%{box-shadow:0 0 0 0 rgba(111,177,255,.0)}50%{box-shadow:0 0 0 6px rgba(111,177,255,.45)}100%{box-shadow:0 0 0 0 rgba(111,177,255,.0)}}
.card.blink{animation:hintBlink 1s ease-in-out 4}

/* dock */
.dock{position:fixed;left:0;right:0;bottom:0;z-index:85;background:linear-gradient(180deg, rgba(11,15,20,0), rgba(11,15,20,.95));padding:10px 12px calc(12px + env(safe-area-inset-bottom,0px));display:flex;justify-content:center}
.dock .inner{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center;max-width:900px;width:100%}
#hint{display:flex;flex-direction:column;align-items:center;gap:2px;min-width:180px;padding:12px 14px}.hline1{font-weight:900}.hline2{font-size:12px;opacity:.9}

/* toast */
.toast{position:fixed;left:50%;bottom:96px;transform:translateX(-50%);background:#0b1218;border:1px solid #1f2a39;color:#cfe1ff;padding:12px 16px;border-radius:14px;opacity:0;animation:pop 4.6s ease-out forwards;z-index:99999;box-shadow:0 10px 30px rgba(0,0,0,.45)}
@keyframes pop{0%{opacity:0;transform:translateX(-50%) translateY(10px)}10%{opacity:1;transform:translateX(-50%) translateY(0)}85%{opacity:1}100%{opacity:0;transform:translateX(-50%) translateY(4px)}}

/* BIG CELEBRATION MODAL */
.bigModal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:3000}
.bigModal.show{display:flex}
.bigCard{width:min(92vw,560px);background:linear-gradient(180deg,#0f1722,#0b1218);border:1px solid #223347;border-radius:18px;padding:18px;box-shadow:0 24px 60px rgba(0,0,0,.5);text-align:center;position:relative;overflow:hidden}
.spark{position:absolute;inset:-2px;border-radius:20px;pointer-events:none;background:radial-gradient(400px 220px at 70% -10%, rgba(111,177,255,.25), transparent), radial-gradient(420px 180px at 10% 110%, rgba(138,255,179,.18), transparent)}
.badgeNew{display:inline-flex;align-items:center;gap:8px;background:rgba(138,255,156,.08);border:1px solid rgba(138,255,156,.35);color:var(--success);padding:6px 10px;border-radius:999px;font-weight:800;margin:6px auto 12px}
.elEmoji{font-size:70px;filter:drop-shadow(0 10px 18px rgba(0,0,0,.45))}
.elName{font-size:22px;font-weight:900;margin-top:6px}
.elRare{font-size:12px;margin-top:2px}
.elRare.common{color:#b9c6d3}.elRare.rare{color:#9dccff}.elRare.epic{color:#ffd166}
.fact{margin-top:12px;color:#cfe1ff;font-size:14px;line-height:1.35;opacity:.95}
.okBtn{margin-top:16px;background:#6fb1ff;border:none;color:#07101c;font-weight:900;padding:12px 18px;border-radius:12px;cursor:pointer}
#confetti{position:fixed;inset:0;pointer-events:none;z-index:2999}

/* Hint mini-panel (names) */
.hintPanel{position:fixed;left:50%;top:68px;transform:translateX(-50%);z-index:2500;background:#0b1218;border:1px solid #223347;border-radius:14px;padding:10px 14px;display:none;gap:8px;align-items:center;box-shadow:0 10px 34px rgba(0,0,0,.45)}
.hintPanel.show{display:flex}
.hRow{display:flex;align-items:center;gap:8px;font-weight:800}
.hRow .emo{font-size:18px}.hRow .txt{font-size:14px;color:#cfe1ff}
.hRow .sep{opacity:.6}

/* Journal panel */
.journal{position:fixed;top:0;right:0;bottom:0;width:min(420px,92vw);background:#0b1218;border-left:1px solid #1f2a39;z-index:3500;transform:translateX(100%);transition:transform .28s cubic-bezier(.2,.8,.2,1), box-shadow .28s;box-shadow:-12px 0 28px rgba(0,0,0,0)}
.journal.show{transform:translateX(0);box-shadow:-12px 0 28px rgba(0,0,0,.35)}
.j-head{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #1f2a3a;background:#0f1620}
.j-title{font-weight:900}
.j-close{background:#162030;border:1px solid #223247;border-radius:10px;color:#cfe1ff;padding:6px 10px;cursor:pointer}
.j-list{padding:10px 12px;overflow:auto}
.j-item{display:flex;align-items:center;gap:10px;padding:10px 8px;border-bottom:1px dashed #1b2a3a}
.j-emo{font-size:20px}.j-name{font-size:14px;color:#cfe1ff;font-weight:700}.j-time{margin-left:auto;font-size:12px;color:#9fb0bf}

/* mobile */
@media (max-width:520px){
  .tools{padding:6px;gap:6px;border-radius:10px}
  #grid{height:60vh}
  .tools.compact{transform:translateY(-120%);opacity:0;pointer-events:none}
  .hintPanel{top:60px}
}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="title">Elementix ‚Äî –∞–ª—Ö–∏–º–∏—è</div>
    <div class="spacer"></div>
    <button class="soundBtn" id="soundBtn">üîä –ó–≤—É–∫</button>
    <div class="gold">ü™ô –ó–æ–ª–æ—Ç–æ: <span id="stars">20</span></div>
  </div>

  <div class="crumbs" id="crumbs"></div>

  <div class="main">
    <div class="bowls">
      <div class="drop" id="bA"><div class="hint">–ü–µ—Ä–µ—Ç–∞—â–∏ –∏–ª–∏ –∫–ª–∏–∫–Ω–∏ –∫–∞—Ä—Ç–æ—á–∫—É</div></div>
      <div class="drop" id="bB"><div class="hint">–ü–µ—Ä–µ—Ç–∞—â–∏ –∏–ª–∏ –∫–ª–∏–∫–Ω–∏ –∫–∞—Ä—Ç–æ—á–∫—É</div></div>
    </div>

    <div class="tools" id="tools">
      <input id="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–æ–ª–ª–µ–∫—Ü–∏–∏‚Ä¶">
      <button id="logBtn" class="btn">üìú –ñ—É—Ä–Ω–∞–ª</button>
      <button id="reset" class="btn">–°–±—Ä–æ—Å</button>
      <div class="count">–û—Ç–∫—Ä—ã—Ç–æ: <span id="openCount">0</span> / <span id="totalCount">300</span> ‚Ä¢ v127v</div>

      <div class="chips" id="chips">
        <div class="chip" data-chip="all">–í—Å–µ</div>
        <div class="chip" data-chip="common">–û–±—ã—á–Ω—ã–π</div>
        <div class="chip" data-chip="rare">–†–µ–¥–∫–∏–π</div>
        <div class="chip" data-chip="epic">–≠–ø–∏—á–µ—Å–∫–∏–π</div>
      </div>
    </div>

    <div class="gridWrap"><div id="grid"><div id="gridInner" class="gridInner"></div></div></div>
  </div>

  <div class="dock"><div class="inner">
    <button id="hint" class="btn"><div class="hline1" id="h1">–ü–æ–¥—Å–∫–∞–∑–∫–∞</div><div class="hline2" id="h2">–±–µ—Å–ø–ª–∞—Ç–Ω–æ</div></button>
    <button id="mix" class="btn primary">–°–º–µ—à–∞—Ç—å</button>
    <button id="clear" class="btn">–û—á–∏—Å—Ç–∏—Ç—å —á–∞—à–∏</button>
  </div></div>
</div>

<button class="fab" id="toTop" style="display:none;position:fixed;right:14px;bottom:110px;z-index:90;background:#0f1a26;border:1px solid #243447;border-radius:999px;color:#cfe1ff;padding:10px 12px">‚¨ÜÔ∏è –ù–∞–≤–µ—Ä—Ö</button>

<!-- celebration modal + confetti -->
<canvas id="confetti" style="display:none"></canvas>
<div class="bigModal" id="newModal" aria-hidden="true">
  <div class="bigCard" role="dialog" aria-live="polite">
    <div class="spark"></div>
    <div class="badgeNew">‚ú® –ù–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç!</div>
    <div class="elEmoji" id="nmEmoji">‚ú®</div>
    <div class="elName" id="nmName">–ù–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç</div>
    <div class="elRare common" id="nmRare">–û–±—ã—á–Ω—ã–π</div>
    <div class="fact" id="nmFact">–ö–∞–∂–¥—ã–π –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç ‚Äî —à–∞–≥ –∫ –≤–µ–ª–∏–∫–∏–º –æ—Ç–∫—Ä—ã—Ç–∏—è–º!</div>
    <button class="okBtn" id="newOk">–û–∫–µ–π</button>
  </div>
</div>

<!-- Hint panel (names) -->
<div class="hintPanel" id="hintPanel">
  <div class="hRow"><span class="emo" id="pA">?</span><span class="txt" id="tA">–≠–ª–µ–º–µ–Ω—Ç A</span>
    <span class="sep">+</span>
    <span class="emo" id="pB">?</span><span class="txt" id="tB">–≠–ª–µ–º–µ–Ω—Ç B</span>
    <span class="sep">‚Üí</span>
    <span class="emo" id="pO">?</span><span class="txt" id="tO">–†–µ–∑—É–ª—å—Ç–∞—Ç</span>
  </div>
</div>

<!-- Journal panel -->
<div id="journal" class="journal">
  <div class="j-head">
    <div class="j-title">–ñ—É—Ä–Ω–∞–ª –æ—Ç–∫—Ä—ã—Ç–∏–π</div>
    <button id="jClose" class="j-close">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
  <div id="jList" class="j-list"></div>
</div>

<script>
/* ===== Config ===== */
const MAX_ELEMENTS=300;
const SOUND_URL = 'assets/new-element.mp3';
const FIXED_VOLUME = 0.8;

/* ===== Data ===== */
const BASE=[["fire","–û–≥–æ–Ω—å","üî•","common"],["water","–í–æ–¥–∞","üíß","common"],["earth","–ó–µ–º–ª—è","ü™®","common"],["air","–í–æ–∑–¥—É—Ö","üí®","common"]];
const OFFICIAL={"steam":{"n":"–ü–∞—Ä","e":"‚ô®Ô∏è","r":"common"},"mud":{"n":"–ì—Ä—è–∑—å","e":"üü´","r":"common"},"dust":{"n":"–ü—ã–ª—å","e":"üßπ","r":"common"},"lava":{"n":"–õ–∞–≤–∞","e":"üåã","r":"common"},"stone":{"n":"–ö–∞–º–µ–Ω—å","e":"üóø","r":"common"},"sand":{"n":"–ü–µ—Å–æ–∫","e":"üèñÔ∏è","r":"common"},"glass":{"n":"–°—Ç–µ–∫–ª–æ","e":"ü™ü","r":"common"},"pressure":{"n":"–î–∞–≤–ª–µ–Ω–∏–µ","e":"üßØ","r":"common"},"mountain":{"n":"–ì–æ—Ä–∞","e":"‚õ∞Ô∏è","r":"rare"},"rain":{"n":"–î–æ–∂–¥—å","e":"üåßÔ∏è","r":"common"},"energy":{"n":"–≠–Ω–µ—Ä–≥–∏—è","e":"‚ö°Ô∏è","r":"rare"},"cloud":{"n":"–¢—É—á–∞","e":"‚òÅÔ∏è","r":"common"},"ash":{"n":"–ü–µ–ø–µ–ª","e":"üå´Ô∏è","r":"common"},"clay":{"n":"–ì–ª–∏–Ω–∞","e":"üß±","r":"common"},"metal":{"n":"–ú–µ—Ç–∞–ª–ª","e":"üî©","r":"rare"},"wind":{"n":"–í–µ—Ç–µ—Ä","e":"üå¨Ô∏è","r":"common"},"ice":{"n":"–õ—ë–¥","e":"üßä","r":"common"},"snow":{"n":"–°–Ω–µ–≥","e":"‚ùÑÔ∏è","r":"common"}};
const RECIPES={
  "fire+water":"steam","earth+water":"mud","earth+air":"dust","fire+earth":"lava",
  "air+air":"pressure","earth+pressure":"mountain","water+air":"rain"
};
const FACTS={"steam":"–ü–∞—Ä –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è, –ø–æ—Ç–æ–º—É —á—Ç–æ –≥–æ—Ä—è—á–∏–π –≤–æ–∑–¥—É—Ö –ª–µ–≥—á–µ —Ö–æ–ª–æ–¥–Ω–æ–≥–æ.","mud":"–ì—Ä—è–∑—å —É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–ª–∞–≥—É –∏ –ø–æ–º–æ–≥–∞–µ—Ç —Ä–∞—Å—Ç–µ–Ω–∏—è–º —Ä–∞—Å—Ç–∏.","dust":"–ü—ã–ª—å ‚Äî –º–∏–∫—Ä–æ—á–∞—Å—Ç–∏—Ü—ã –∑–µ–º–ª–∏ –∏ –ø—ã–ª—å—Ü—ã.","lava":"–õ–∞–≤–∞ ‚Äî —Ä–∞—Å–ø–ª–∞–≤–ª–µ–Ω–Ω–∞—è –ø–æ—Ä–æ–¥–∞ –∏–∑ –Ω–µ–¥—Ä –ó–µ–º–ª–∏.","stone":"–ö–∞–º–µ–Ω—å ‚Äî –æ—Å–Ω–æ–≤–∞ –≥–æ—Ä.","sand":"–°—Ç–µ–∫–ª–æ –¥–µ–ª–∞—é—Ç –∏–∑ –ø–µ—Å–∫–∞ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–µ.","glass":"–ê–º–æ—Ä—Ñ–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–µ–ª–∞–µ—Ç —Å—Ç–µ–∫–ª–æ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–º.","pressure":"–î–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω—è–µ—Ç —Å–≤–æ–π—Å—Ç–≤–∞ –≤–µ—â–µ—Å—Ç–≤.","mountain":"–ì–æ—Ä—ã —Ä–∞—Å—Ç—É—Ç, –∫–æ–≥–¥–∞ –ø–ª–∏—Ç—ã —Å—Ç–∞–ª–∫–∏–≤–∞—é—Ç—Å—è.","rain":"–î–æ–∂–¥—å ‚Äî –≤–æ–¥–∞ –∏–∑ –æ–±–ª–∞–∫–æ–≤."};

/* ===== State ===== */
const SAVE_KEY='elementix-v127v', SOUND_ON_KEY='elementix-sound-on';
const $=id=>document.getElementById(id);
const grid=$('grid'), gridInner=$('gridInner'), bA=$('bA'), bB=$('bB'), crumbs=$('crumbs'), tools=$('tools');
const soundBtn=$('soundBtn'); const jPanel=$('journal'); const jList=$('jList');
let state={
  disc:new Set(BASE.map(x=>x[0])),
  order:[...BASE.map(x=>x[0])],
  a:null,b:null,
  stars:20,
  journal:[],
  soundOn:true,
  filter:'all',
  widthCols:4, cardW:0, cardH:132, gap:12, data:[]
};
try{
  const raw=localStorage.getItem(SAVE_KEY); if(raw){ const o=JSON.parse(raw);
    state.disc=new Set(o.d||BASE.map(x=>x[0])); state.order=o.o&&o.o.length?o.o:[...state.disc];
    state.a=o.a||null; state.b=o.b||null; state.stars=(typeof o.stars==='number')?o.stars:20; state.journal=Array.isArray(o.journal)?o.journal:[]; state.filter=o.filter||'all';
  }
}catch{}
try{ const s=localStorage.getItem(SOUND_ON_KEY); if(s!==null) state.soundOn=(s==='1'); }catch{}
function persist(){ localStorage.setItem(SAVE_KEY, JSON.stringify({d:[...state.disc],o:state.order,a:state.a,b:state.b,stars:state.stars,journal:state.journal,filter:state.filter})); localStorage.setItem(SOUND_ON_KEY, state.soundOn?'1':'0'); }

/* ===== Helpers ===== */
function ALL(){ const m=new Map(); BASE.forEach(([i,n,e,r])=>m.set(i,{id:i,n,e,r})); Object.entries(OFFICIAL).forEach(([k,v])=>m.set(k,{id:k,n:v.n,e:v.e,r:v.r})); return m; }
function nameOf(id){ const it=ALL().get(id)||{n:id,e:'?'}; return `${it.e} ${it.n}`; }
function keyFor(a,b){ return [a,b].sort().join('+'); }

/* ===== Sound ===== */
function updateSoundBtn(){ soundBtn.textContent= state.soundOn?'üîä –ó–≤—É–∫':'üîá –ó–≤—É–∫'; }
soundBtn.addEventListener('click',()=>{ state.soundOn=!state.soundOn; updateSoundBtn(); persist(); });
updateSoundBtn();
async function playSound(){ if(!state.soundOn) return; try{ const a=new Audio(SOUND_URL); a.volume=FIXED_VOLUME; await a.play(); }catch(e){} }

/* ===== Toast ===== */
function toast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),4600); }

/* ===== Confetti ===== */
let confettiTimer=null, confettiCanvas=$('confetti'), confettiStart=0;
function startConfetti(){
  stopConfetti();
  confettiCanvas.style.display='block';
  const ctx=confettiCanvas.getContext('2d');
  function fit(){ confettiCanvas.width=innerWidth; confettiCanvas.height=innerHeight; } fit(); addEventListener('resize',fit);
  const N=220; let parts=Array.from({length:N},()=>({x:Math.random()*innerWidth,y:Math.random()*-innerHeight,r:2+Math.random()*4,s:1+Math.random()*2.5,a:Math.random()*Math.PI*2,c:['#ffd166','#6fb1ff','#8aff9c','#ff9aa2','#fbd6ff'][Math.floor(Math.random()*5)]}));
  confettiStart=performance.now();
  function draw(now){
    const elapsed = now - confettiStart; let factor=1; if(elapsed>4000){ factor=Math.max(0,1-(elapsed-4000)/2000); }
    ctx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
    for(const p of parts){ if(elapsed>4000 && Math.random()>factor) continue; ctx.beginPath(); ctx.fillStyle=p.c; ctx.globalAlpha=0.85*factor; ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill(); p.y+=p.s; p.x+=Math.sin(p.a)*0.8; p.a+=0.02; if(p.y-p.r>confettiCanvas.height){ if(factor>0.05){ p.y=-10; p.x=Math.random()*confettiCanvas.width; } } }
    if(factor<=0){ stopConfetti(); return; }
    confettiTimer=requestAnimationFrame(draw);
  }
  confettiTimer=requestAnimationFrame(draw);
}
function stopConfetti(){ if(confettiTimer){ cancelAnimationFrame(confettiTimer); confettiTimer=null; } confettiCanvas.style.display='none'; }

/* ===== Big Celebration Modal ===== */
let savedScrollY=0; function lockScroll(lock){ if(lock){ savedScrollY=scrollY; document.body.style.top=`-${savedScrollY}px`; document.body.style.position='fixed'; document.body.style.left='0'; document.body.style.right='0'; } else { document.body.style.position=''; document.body.style.top=''; document.body.style.left=''; document.body.style.right=''; scrollTo(0,savedScrollY||0);} }
function celebrateNew(id,item){
  $('nmEmoji').textContent=item.e||'‚ú®'; $('nmName').textContent=item.n||'–ù–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç';
  const rare=item.r||'common'; const rr=rare==='epic'?'–≠–ø–∏—á–µ—Å–∫–∏–π':(rare==='rare'?'–†–µ–¥–∫–∏–π':'–û–±—ã—á–Ω—ã–π');
  $('nmRare').textContent=rr; $('nmRare').className='elRare '+rare;
  $('nmFact').textContent=FACTS[id]||"–ö–∞–∂–¥—ã–π –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç ‚Äî —à–∞–≥ –∫ –≤–µ–ª–∏–∫–∏–º –æ—Ç–∫—Ä—ã—Ç–∏—è–º!";
  const modal=$('newModal'); lockScroll(true); modal.classList.add('show'); modal.setAttribute('aria-hidden','false'); startConfetti(); playSound();
  $('newOk').onclick=()=>{ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); stopConfetti(); lockScroll(false); };
}

/* ===== Journal ===== */
function renderJournal(){ const fmt=iso=>{ try{const d=new Date(iso);return d.toLocaleString('ru-RU',{hour:'2-digit',minute:'2-digit',day:'2-digit',month:'2-digit'});}catch{return ''}}; jList.innerHTML=(state.journal||[]).map(it=>`<div class="j-item"><div class="j-emo">${it.e||'‚ú®'}</div><div class="j-name">${it.n||'–ù–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç'}</div><div class="j-time">${fmt(it.t)}</div></div>`).join('')||`<div style="color:#9fb0bf;opacity:.9;padding:12px">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –û—Ç–∫—Ä—ã–≤–∞–π –Ω–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã ‚Äî –∑–∞–ø–∏—Å–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å.</div>`; }
$('logBtn').addEventListener('click',()=>{ renderJournal(); jPanel.classList.add('show'); });
$('jClose').addEventListener('click',()=> jPanel.classList.remove('show'));

/* ===== Chips (rarity filter) ===== */
const chips=$('chips'); chips.addEventListener('click',(e)=>{ const chip=e.target.closest('.chip'); if(!chip) return; state.filter=chip.dataset.chip; chips.querySelectorAll('.chip').forEach(c=>c.classList.toggle('active', c===chip)); buildDataList(); renderVirtual(); persist(); });

/* ===== Grid virtualization ===== */
function computeLayout(){
  const w=grid.clientWidth||innerWidth; let cols=2; if(w>520) cols=3; if(w>760) cols=4; if(w>1024) cols=5;
  state.widthCols=cols; state.cardW=Math.floor((w-(cols-1)*state.gap)/cols);
  const css=document.getElementById('dynW')||(()=>{const s=document.createElement('style');s.id='dynW';document.head.appendChild(s);return s;})();
  css.innerHTML=`.card{width:${state.cardW}px}`;
}
function buildDataList(){ const A=ALL(); const q=(($('search').value)||'').toLowerCase(); let items=[...state.order].filter(id=>A.has(id)&&state.disc.has(id));
  if(state.filter!=='all'){ items=items.filter(id=> (A.get(id).r||'common')===state.filter); }
  if(q){ items=items.filter(id=>A.get(id).n.toLowerCase().includes(q)); }
  state.data=items.map(id=>({id,...A.get(id)})); $('openCount').textContent=[...state.disc].length;
}
function renderVirtual(){ computeLayout(); const gap=state.gap,cw=state.cardW,ch=state.cardH,cols=state.widthCols;
  const total=state.data.length; const rows=Math.ceil(total/cols); const totalH=rows*(ch+gap)-gap; gridInner.style.height=totalH+'px';
  const st=grid.scrollTop, vh=grid.clientHeight; const firstRow=Math.max(0,Math.floor(st/(ch+gap))-2); const lastRow=Math.min(rows-1,Math.floor((st+vh)/(ch+gap))+2);
  const first=firstRow*cols; const last=Math.min(total-1,(lastRow+1)*cols-1); gridInner.innerHTML='';
  for(let i=first;i<=last;i++){ const it=state.data[i]; if(!it) continue; const row=Math.floor(i/cols), col=i%cols; const x=col*(cw+gap), y=row*(ch+gap);
    const d=document.createElement('div'); d.className='card'; d.style.transform=`translate(${x}px,${y}px)`; d.style.height=ch+'px'; d.dataset.id=it.id; d.dataset.rarity=it.r||'common'; d.setAttribute('draggable','true');
    d.addEventListener('dragstart',e=>e.dataTransfer.setData('text/plain',it.id));
    d.addEventListener('click',()=>selectByClick(it.id));
    d.innerHTML=`<div class="tag">${it.r==='rare'?'–†–µ–¥–∫–∏–π':it.r==='epic'?'–≠–ø–∏—á–µ—Å–∫–∏–π':'–û–±—ã—á–Ω—ã–π'}</div><div class="emoji">${it.e}</div><div class="name">${it.n}</div>`;
    gridInner.appendChild(d);
  }
}
grid.addEventListener('scroll',()=>{ renderVirtual(); $('toTop').style.display = grid.scrollTop>grid.clientHeight ? 'block':'none'; });

/* ===== Selection & bowls ===== */
[bA,bB].forEach((b,ix)=>{ b.addEventListener('dragover',e=>e.preventDefault()); b.addEventListener('drop',e=>{e.preventDefault(); const id=e.dataTransfer.getData('text/plain'); if(!ALL().has(id))return; setToBowl(id,ix==0?'A':'B');});});
function bowlBlock(id){ if(!id) return '<div class="hint">–ü–µ—Ä–µ—Ç–∞—â–∏ –∏–ª–∏ –∫–ª–∏–∫–Ω–∏ –∫–∞—Ä—Ç–æ—á–∫—É</div>'; const it=ALL().get(id); return `<div class="selection"><div class="emoji">${it.e}</div><div class="name">${it.n}</div></div>`; }
function renderBowls(){ bA.innerHTML=bowlBlock(state.a); bB.innerHTML=bowlBlock(state.b); renderCrumbs(); }
function renderCrumbs(){ const parts=[]; if(state.a){ const it=ALL().get(state.a); parts.push(`<div class="token"><div class="emo">${it.e}</div></div>`);} if(state.b){ const it=ALL().get(state.b); parts.push(`<div class="token"><div class="emo">${it.e}</div></div>`);} crumbs.innerHTML=parts.join('')||'<div style="color:#9fb0bf;font-size:12px;padding:2px 6px">–í—ã–±–µ—Ä–∏ 2 —ç–ª–µ–º–µ–Ω—Ç–∞‚Ä¶</div>'; }
function selectByClick(id){ const target=!state.a?'A':(!state.b?'B':'A'); setToBowl(id,target); }
function setToBowl(id,which){ if(which==='A') state.a=id; else state.b=id; renderBowls(); persist(); }

/* ===== Hint ===== */
const hintPanel=$('hintPanel'); const pA=$('pA'), pB=$('pB'), pO=$('pO'); const tA=$('tA'), tB=$('tB'), tO=$('tO');
function autoScrollTo(id){ const node=[...document.querySelectorAll('.card')].find(n=>n.dataset.id===id); if(!node){ return; } const rect=node.getBoundingClientRect(); const gRect=grid.getBoundingClientRect(); const offset=rect.top-gRect.top; if(offset<0 || offset>grid.clientHeight-120){ grid.scrollTop += offset-60; setTimeout(()=>{ const n2=[...document.querySelectorAll('.card')].find(n=>n.dataset.id===id); if(n2){ n2.classList.add('glow','blink'); } },120); } else { node.classList.add('glow','blink'); } setTimeout(()=>document.querySelectorAll('.card.blink').forEach(n=>n.classList.remove('blink')),4200); setTimeout(()=>document.querySelectorAll('.card.glow').forEach(n=>n.classList.remove('glow')),4200); }
$('hint').addEventListener('click',()=>{
  const known=[...state.disc]; const seen=new Set(known);
  let choice=null;
  for(let i=0;i<known.length;i++){
    for(let j=i;j<known.length;j++){
      const out=RECIPES[keyFor(known[i],known[j])];
      if(out && !seen.has(out)){ choice=[known[i],known[j],out]; break; }
    } if(choice) break;
  }
  if(choice){
    const [a,b,out]=choice; const A=ALL();
    // panel with names
    pA.textContent=A.get(a).e; tA.textContent=A.get(a).n;
    pB.textContent=A.get(b).e; tB.textContent=A.get(b).n;
    pO.textContent=(OFFICIAL[out]?.e)||'‚ú®'; tO.textContent=(OFFICIAL[out]?.n)||out;
    hintPanel.classList.add('show');
    setTimeout(()=>hintPanel.classList.remove('show'), 3600);
    // highlight + autoscroll
    autoScrollTo(a); autoScrollTo(b);
  }else{
    toast('–ü–æ–¥—Å–∫–∞–∑–∫–∞: –Ω–æ–≤—ã—Ö –∫–æ–º–±–∏–Ω–∞—Ü–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
  }
});

/* ===== Craft ===== */
$('mix').addEventListener('click',async ()=>{
  if(!state.a || !state.b){ toast('–í—ã–±–µ—Ä–∏ 2 —ç–ª–µ–º–µ–Ω—Ç–∞'); return; }
  const out = RECIPES[keyFor(state.a,state.b)];
  if(!out){ toast('–ù–∏—á–µ–≥–æ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å'); return; }
  const it=ALL().get(out)||{n:out,e:'‚ú®',r:'common'};
  const isNew=!state.disc.has(out);
  state.a=null; state.b=null; renderBowls();
  if(isNew){
    state.disc.add(out); state.order.push(out);
    state.journal.unshift({id:out,n:it.n,e:it.e,t:new Date().toISOString()}); if(state.journal.length>500) state.journal.pop();
    celebrateNew(out,it); await playSound();
  } else {
    toast('–ü–æ–ª—É—á–∏–ª–æ—Å—å: '+nameOf(out));
    await playSound();
  }
  persist(); buildDataList(); renderVirtual();
});

/* ===== Other controls ===== */
$('clear').addEventListener('click',()=>{ state.a=null; state.b=null; renderBowls(); persist(); });
$('reset').addEventListener('click',()=>{ localStorage.removeItem(SAVE_KEY); location.reload(); });
$('toTop').addEventListener('click',()=>{ grid.scrollTo({top:0,behavior:'smooth'}); });

/* ===== Search ===== */
$('search').addEventListener('input',(()=>{ let t; return ()=>{ clearTimeout(t); t=setTimeout(()=>{ buildDataList(); renderVirtual(); },120); }; })());

/* ===== Hide tools on mobiles ===== */
let lastWinY=window.scrollY||0;
window.addEventListener('scroll',()=>{ const y=window.scrollY||0; if(y>lastWinY+10){ tools.classList.add('compact'); } else if(y<lastWinY-10){ tools.classList.remove('compact'); } lastWinY=y; });

/* ===== Init ===== */
function init(){
  document.getElementById('totalCount').textContent=MAX_ELEMENTS;
  document.getElementById('openCount').textContent=[...state.disc].length;
  // set active chip
  [...document.querySelectorAll('.chip')].forEach(c=>c.classList.toggle('active', c.dataset.chip===state.filter));
  renderBowls(); buildDataList(); renderVirtual();
}
init();
</script>
</body></html>
